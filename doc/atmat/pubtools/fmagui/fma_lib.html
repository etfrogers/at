<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of fma_lib</title>
  <meta name="keywords" content="fma_lib">
  <meta name="description" content="This library contains functions needed by FMA_GUI which sets up the">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">atmat</a> &gt; <a href="../index.html">pubtools</a> &gt; <a href="index.html">fmagui</a> &gt; fma_lib.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for atmat/pubtools/fmagui&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>fma_lib
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>This library contains functions needed by FMA_GUI which sets up the</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function varargout = fma_lib(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> This library contains functions needed by FMA_GUI which sets up the
 initial conditions/parameters and provides an interface for the analysis.
 The functions in this library are listed below.

   readfmadata: Reading data file containing FMA related data.
   writefmadata: Writing a file containing FMA related data.
   analysis: The routine to calculate the frequency map.
   freqsearch: Routine to apply modified Fourier Transform to extract
               the dominant frequency term.
   plotfm: Plot the results stored in the FMA structure.

 COMMANDS:
    'read'
    'write'
    'analysis'
    'plotfm'
    'freqsearch'
    'lineanalysis'
    'interactive'

 USAGE:
    [fmadatastructure status] = fma_lib('read',filename);
    success = fma_lib('write',filename,fma);
    [fmadatastructure status] = fma_lib('analysis',fma,fmagui);
    freq = fma_lib('freqsearch',data,[RANGE, DT, TOLERANCE, SEARCHWINDOW]);
    fighandles = fma_lib('plotfm',fma,['file']);

 16/11/2004 Eugene Tan: Created
 26/11/2009 Eugene Tan: updated for new version of Matlab and MiddleLayer.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="fma_lib.html" class="code" title="function varargout = fma_lib(varargin)">fma_lib</a>	This library contains functions needed by FMA_GUI which sets up the</li><li><a href="lasso.html" class="code" title="function [selx,sely,indexnr]=lasso(x,y)">lasso</a>	lasso -  enables the selection/encircling of (clusters of) events in a scatter plot by hand</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="fma_gui.html" class="code" title="function varargout = fma_base_gui(varargin)">fma_gui</a>	</li><li><a href="fma_lib.html" class="code" title="function varargout = fma_lib(varargin)">fma_lib</a>	This library contains functions needed by FMA_GUI which sets up the</li><li><a href="plot_emailresults.html" class="code" title="function plot_emailresults(fma)">plot_emailresults</a>	</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [fma, status] = readfmadata(filename)</a></li><li><a href="#_sub2" class="code">function varargout = writefmadata(filename, fma)</a></li><li><a href="#_sub3" class="code">function [fma, status] = analysis(varargin)</a></li><li><a href="#_sub4" class="code">function varargout = local_freqsearch(data, varargin)</a></li><li><a href="#_sub5" class="code">function fctnsum = midpointsum(fctn)</a></li><li><a href="#_sub6" class="code">function psi = midpointsum1(data,kai,t,sigma)</a></li><li><a href="#_sub7" class="code">function varargout = plotfm(varargin)</a></li><li><a href="#_sub8" class="code">function varargout = fma_points_around_resonance(a,b,c,periodicity,maxd,varargin)</a></li><li><a href="#_sub9" class="code">function varargout = interactive_selection(varargin)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function varargout = fma_lib(varargin)</a>
0002 
0003 <span class="comment">% This library contains functions needed by FMA_GUI which sets up the</span>
0004 <span class="comment">% initial conditions/parameters and provides an interface for the analysis.</span>
0005 <span class="comment">% The functions in this library are listed below.</span>
0006 <span class="comment">%</span>
0007 <span class="comment">%   readfmadata: Reading data file containing FMA related data.</span>
0008 <span class="comment">%   writefmadata: Writing a file containing FMA related data.</span>
0009 <span class="comment">%   analysis: The routine to calculate the frequency map.</span>
0010 <span class="comment">%   freqsearch: Routine to apply modified Fourier Transform to extract</span>
0011 <span class="comment">%               the dominant frequency term.</span>
0012 <span class="comment">%   plotfm: Plot the results stored in the FMA structure.</span>
0013 <span class="comment">%</span>
0014 <span class="comment">% COMMANDS:</span>
0015 <span class="comment">%    'read'</span>
0016 <span class="comment">%    'write'</span>
0017 <span class="comment">%    'analysis'</span>
0018 <span class="comment">%    'plotfm'</span>
0019 <span class="comment">%    'freqsearch'</span>
0020 <span class="comment">%    'lineanalysis'</span>
0021 <span class="comment">%    'interactive'</span>
0022 <span class="comment">%</span>
0023 <span class="comment">% USAGE:</span>
0024 <span class="comment">%    [fmadatastructure status] = fma_lib('read',filename);</span>
0025 <span class="comment">%    success = fma_lib('write',filename,fma);</span>
0026 <span class="comment">%    [fmadatastructure status] = fma_lib('analysis',fma,fmagui);</span>
0027 <span class="comment">%    freq = fma_lib('freqsearch',data,[RANGE, DT, TOLERANCE, SEARCHWINDOW]);</span>
0028 <span class="comment">%    fighandles = fma_lib('plotfm',fma,['file']);</span>
0029 <span class="comment">%</span>
0030 <span class="comment">% 16/11/2004 Eugene Tan: Created</span>
0031 <span class="comment">% 26/11/2009 Eugene Tan: updated for new version of Matlab and MiddleLayer.</span>
0032 
0033 <span class="keyword">if</span> nargin &lt; 1
0034     error(<span class="string">'See help on fma_lib'</span>);
0035 <span class="keyword">end</span>
0036 
0037 <span class="comment">% Switch yard</span>
0038 <span class="keyword">switch</span>(varargin{1})
0039     <span class="keyword">case</span> <span class="string">'read'</span>
0040         <span class="keyword">if</span> nargin &gt;=2 &amp;&amp; ischar(varargin{2})
0041             [fma status] = <a href="#_sub1" class="code" title="subfunction [fma, status] = readfmadata(filename)">readfmadata</a>(varargin{2});
0042             varargout{1} = fma;
0043             varargout{2} = status;
0044         <span class="keyword">else</span>
0045             error(<span class="string">'Error using ''read'' option. See help on fma_lib'</span>);
0046         <span class="keyword">end</span>
0047     <span class="keyword">case</span> <span class="string">'write'</span>
0048         <span class="keyword">if</span> nargin &gt;= 3 &amp;&amp; ischar(varargin{2}) &amp;&amp; isstruct(varargin{3})
0049             varargout{1} = <a href="#_sub2" class="code" title="subfunction varargout = writefmadata(filename, fma)">writefmadata</a>(varargin{2},varargin{3});
0050         <span class="keyword">else</span>
0051             error(<span class="string">'Error using ''write'' option. See help on fma_lib'</span>);
0052         <span class="keyword">end</span> 
0053     <span class="keyword">case</span> <span class="string">'analysis'</span>
0054         <span class="keyword">try</span>
0055             [fma status] = <a href="#_sub3" class="code" title="subfunction [fma, status] = analysis(varargin)">analysis</a>(varargin{2:end});
0056             varargout{1} = fma;
0057             varargout{2} = status;
0058             <span class="keyword">if</span> ~status
0059                 disp(lasterr);
0060             <span class="keyword">end</span>
0061         <span class="keyword">catch</span>
0062             disp(lasterr)
0063             varargout{1} = [];
0064             varargout{2} = 0;
0065         <span class="keyword">end</span>
0066     <span class="keyword">case</span> <span class="string">'freqsearch'</span>
0067         varargout{1} = <a href="#_sub4" class="code" title="subfunction varargout = local_freqsearch(data, varargin)">local_freqsearch</a>(varargin{2:end});
0068     <span class="keyword">case</span> <span class="string">'plotfm'</span>
0069         handles = <a href="#_sub7" class="code" title="subfunction varargout = plotfm(varargin)">plotfm</a>(varargin{2:end});
0070         varargout{1} = handles;
0071     <span class="keyword">case</span> <span class="string">'lineanalysis'</span>
0072         <a href="#_sub8" class="code" title="subfunction varargout = fma_points_around_resonance(a,b,c,periodicity,maxd,varargin)">fma_points_around_resonance</a>(varargin{2:end});
0073     <span class="keyword">case</span> <span class="string">'interactive'</span>
0074         <a href="#_sub9" class="code" title="subfunction varargout = interactive_selection(varargin)">interactive_selection</a>(varargin{2:end});
0075     <span class="keyword">otherwise</span>
0076         disp([<span class="string">'Unknown option: '</span> varargin{1}]);
0077 <span class="keyword">end</span>
0078 
0079 
0080 
0081 <span class="comment">% ==============</span>
0082 <span class="comment">%  Read FMA struct saved in a text file</span>
0083 <span class="comment">% ==============</span>
0084 <a name="_sub1" href="#_subfunctions" class="code">function [fma, status] = readfmadata(filename)</a>
0085 
0086 [fin msg] = fopen(filename,<span class="string">'r'</span>);
0087 status = 1;
0088 
0089 <span class="keyword">if</span> fin &lt; 0
0090     fma = [];
0091     status = 0;
0092     lasterr(msg);
0093     <span class="keyword">return</span>
0094 <span class="keyword">end</span>
0095 
0096 <span class="keyword">try</span>
0097     <span class="comment">% This is for first declaration to simplify process. Will be removed later.</span>
0098     fma.temp = NaN;
0099     <span class="keyword">while</span> ~feof(fin)
0100         <span class="comment">% Read in variable name</span>
0101         varname = fgetl(fin);
0102         <span class="comment">% Read in type</span>
0103         vartype = fgetl(fin);
0104         <span class="comment">% Read number of items to read in</span>
0105         numvar = str2double(fgetl(fin));
0106 
0107         <span class="keyword">if</span> numvar == 0
0108             fgetl(fin);
0109         <span class="keyword">else</span>
0110             <span class="keyword">if</span> strcmpi(vartype,<span class="string">'char'</span>)
0111                 celltemp = cell(1,numvar);
0112                 <span class="comment">% Read in the data</span>
0113                 <span class="keyword">for</span> i=1:numvar
0114                     celltemp{i} = fgetl(fin);
0115                 <span class="keyword">end</span>
0116                 temp = char(celltemp);
0117             <span class="keyword">else</span>
0118                 temp = zeros(1,numvar);
0119                 <span class="comment">% Read in the data</span>
0120                 <span class="keyword">for</span> i=1:numvar
0121                     temp(i) = str2num(fgetl(fin));
0122                 <span class="keyword">end</span>
0123             <span class="keyword">end</span>
0124 
0125             eval([varname <span class="string">'='</span> <span class="string">'temp;'</span>]);
0126         <span class="keyword">end</span>
0127 
0128     <span class="keyword">end</span>
0129     fma = rmfield(fma,<span class="string">'temp'</span>);
0130 <span class="keyword">catch</span>
0131     lasterr([<span class="string">'Problem reading from file: '</span> filename])
0132     fma = [];
0133     status = 0;
0134 <span class="keyword">end</span>
0135 
0136 fclose(fin);
0137 <span class="comment">% ==============</span>
0138 <span class="comment">% End of readfmadata</span>
0139 <span class="comment">% ==============</span>
0140 
0141 
0142 <span class="comment">% ==============</span>
0143 <span class="comment">%  Write FMA struct to a text file</span>
0144 <span class="comment">% ==============</span>
0145 <a name="_sub2" href="#_subfunctions" class="code">function varargout = writefmadata(filename, fma)</a>
0146 
0147 <span class="comment">% Check if file already exists. If so, rename appropriately.</span>
0148 <span class="keyword">if</span> exist(filename,<span class="string">'file'</span>)
0149     [pathstr namestr ext] = fileparts(filename);
0150     list = cellstr(ls(sprintf(<span class="string">'%s(*'</span>,namestr)));
0151     <span class="keyword">if</span> isempty(list{1})
0152         namestr = [namestr <span class="string">'(1)'</span>];
0153     <span class="keyword">else</span>
0154         <span class="keyword">for</span> i=1:length(list)
0155             token = regexpi(list{i},<span class="string">'\w\((.)\).dat$'</span>,<span class="string">'tokens'</span>);
0156             <span class="keyword">if</span> ~isempty(token)
0157                 num(i) = str2num(token{1}{1});
0158             <span class="keyword">end</span>
0159         <span class="keyword">end</span>
0160         namestr = sprintf(<span class="string">'%s(%d)'</span>,namestr,max(num)+1);
0161     <span class="keyword">end</span>
0162     filename = [pathstr filesep namestr ext];
0163 <span class="keyword">end</span>
0164 [fout msg] = fopen(filename,<span class="string">'w'</span>);
0165 varargout{1} = 1;
0166 
0167 <span class="keyword">if</span> fout &lt; 0
0168     varargout{1} = 0;
0169     lasterr(msg);
0170     <span class="keyword">return</span>
0171 <span class="keyword">end</span>
0172 
0173 <span class="comment">% Print out basic parameters</span>
0174 namelist = {};
0175 namelist = {<span class="string">'version'</span><span class="keyword">...</span>
0176     <span class="string">'latticefile'</span><span class="keyword">...</span>
0177     <span class="string">'resultsfile'</span><span class="keyword">...</span>
0178     <span class="string">'datadir'</span><span class="keyword">...</span>
0179     <span class="string">'starttime'</span><span class="keyword">...</span>
0180     <span class="string">'endtime'</span><span class="keyword">...</span>
0181     <span class="string">'comments'</span><span class="keyword">...</span>
0182     <span class="string">'nturn1'</span><span class="keyword">...</span>
0183     <span class="string">'nturn2'</span><span class="keyword">...</span>
0184     <span class="string">'totaltime'</span><span class="keyword">...</span>
0185     <span class="string">'aperture'</span>};
0186 <span class="keyword">for</span> i=1:length(namelist)
0187     fprintf(fout,<span class="string">'fma.%s\n'</span>,namelist{i});
0188     vartype = class(fma.(namelist{i}));
0189     <span class="keyword">if</span> strcmpi(vartype,<span class="string">'char'</span>)
0190         <span class="comment">% Convert char array into cells</span>
0191         temp = cellstr(fma.(namelist{i}));
0192     <span class="keyword">else</span>
0193         <span class="comment">% Save all other types, typically doubles here.</span>
0194         temp = fma.(namelist{i});
0195     <span class="keyword">end</span>
0196     <span class="comment">% Print type</span>
0197     fprintf(fout,<span class="string">'%s\n'</span>,vartype);
0198     <span class="comment">% Print number/lnegth of variable</span>
0199     fprintf(fout,<span class="string">'%d\n'</span>,numel(temp));
0200     <span class="comment">% Print the variable</span>
0201     <span class="keyword">if</span> strcmpi(vartype,<span class="string">'char'</span>)
0202         <span class="comment">% Print each cell/string on a different line.</span>
0203         <span class="keyword">for</span> j=1:numel(temp)
0204             fprintf(fout,<span class="string">'%s\n'</span>,temp{j});
0205         <span class="keyword">end</span>
0206     <span class="keyword">else</span>
0207         <span class="comment">% Will automatically print on each line if type is numeric.</span>
0208         fprintf(fout,<span class="string">'%17.15f\n'</span>,temp);
0209     <span class="keyword">end</span>
0210     clear temp;
0211 <span class="keyword">end</span>
0212 
0213 <span class="comment">% Mesh</span>
0214 namelist = {};
0215 namelist = {<span class="string">'type'</span><span class="keyword">...</span>
0216     <span class="string">'hor_pos'</span><span class="keyword">...</span>
0217     <span class="string">'maxx_p'</span><span class="keyword">...</span>
0218     <span class="string">'minx_p'</span><span class="keyword">...</span>
0219     <span class="string">'maxdx_p'</span><span class="keyword">...</span>
0220     <span class="string">'mindx_p'</span><span class="keyword">...</span>
0221     <span class="string">'hor_neg'</span><span class="keyword">...</span>
0222     <span class="string">'maxx_n'</span><span class="keyword">...</span>
0223     <span class="string">'minx_n'</span><span class="keyword">...</span>
0224     <span class="string">'maxdx_n'</span><span class="keyword">...</span>
0225     <span class="string">'mindx_n'</span><span class="keyword">...</span>
0226     <span class="string">'ver_pos'</span><span class="keyword">...</span>
0227     <span class="string">'maxy_p'</span><span class="keyword">...</span>
0228     <span class="string">'miny_p'</span><span class="keyword">...</span>
0229     <span class="string">'maxdy_p'</span><span class="keyword">...</span>
0230     <span class="string">'mindy_p'</span><span class="keyword">...</span>
0231     <span class="string">'ver_neg'</span><span class="keyword">...</span>
0232     <span class="string">'maxy_n'</span><span class="keyword">...</span>
0233     <span class="string">'miny_n'</span><span class="keyword">...</span>
0234     <span class="string">'maxdy_n'</span><span class="keyword">...</span>
0235     <span class="string">'mindy_n'</span><span class="keyword">...</span>
0236     <span class="string">'x'</span><span class="keyword">...</span>
0237     <span class="string">'y'</span>};
0238 <span class="keyword">for</span> i=1:length(namelist)
0239     fprintf(fout,<span class="string">'fma.mesh.%s\n'</span>,namelist{i});
0240     vartype = class(fma.mesh.(namelist{i}));
0241     <span class="keyword">if</span> strcmpi(vartype,<span class="string">'char'</span>)
0242         <span class="comment">% Convert char array into cells</span>
0243         temp = cellstr(fma.mesh.(namelist{i}));
0244     <span class="keyword">else</span>
0245         <span class="comment">% Save all other types, typically doubles here.</span>
0246         temp = fma.mesh.(namelist{i});
0247     <span class="keyword">end</span>
0248     <span class="comment">% Print type</span>
0249     fprintf(fout,<span class="string">'%s\n'</span>,vartype);
0250     <span class="comment">% Print number/lnegth of variable</span>
0251     fprintf(fout,<span class="string">'%d\n'</span>,numel(temp));
0252     <span class="comment">% Print the variable</span>
0253     <span class="keyword">if</span> strcmpi(vartype,<span class="string">'char'</span>)
0254         <span class="comment">% Print each cell/string on a different line.</span>
0255         <span class="keyword">for</span> j=1:numel(temp)
0256             fprintf(fout,<span class="string">'%s\n'</span>,temp{j});
0257         <span class="keyword">end</span>
0258     <span class="keyword">else</span>
0259         <span class="comment">% Will automatically print on each line if type is numeric.</span>
0260         fprintf(fout,<span class="string">'%17.15f\n'</span>,temp);
0261     <span class="keyword">end</span>
0262     clear temp;
0263 <span class="keyword">end</span>
0264 
0265 <span class="comment">% Data</span>
0266 namelist = {};
0267 namelist = {<span class="string">'x'</span><span class="keyword">...</span>
0268     <span class="string">'y'</span><span class="keyword">...</span>
0269     <span class="string">'nux1'</span><span class="keyword">...</span>
0270     <span class="string">'nuy1'</span><span class="keyword">...</span>
0271     <span class="string">'nux2'</span><span class="keyword">...</span>
0272     <span class="string">'nuy2'</span><span class="keyword">...</span>
0273     <span class="string">'dindex'</span><span class="keyword">...</span>
0274     <span class="string">'curr'</span><span class="keyword">...</span>
0275     <span class="string">'max'</span>};
0276 <span class="keyword">for</span> i=1:length(namelist)
0277     fprintf(fout,<span class="string">'fma.data.%s\n'</span>,namelist{i});
0278     vartype = class(fma.data.(namelist{i}));
0279     <span class="keyword">if</span> strcmpi(vartype,<span class="string">'char'</span>)
0280         <span class="comment">% Convert char array into cells</span>
0281         temp = cellstr(fma.data.(namelist{i}));
0282     <span class="keyword">else</span>
0283         <span class="comment">% Save all other types, typically doubles here.</span>
0284         temp = fma.data.(namelist{i});
0285     <span class="keyword">end</span>
0286     <span class="comment">% Print type</span>
0287     fprintf(fout,<span class="string">'%s\n'</span>,vartype);
0288     <span class="comment">% Print number/lnegth of variable</span>
0289     fprintf(fout,<span class="string">'%d\n'</span>,numel(temp));
0290     <span class="comment">% Print the variable</span>
0291     <span class="keyword">if</span> strcmpi(vartype,<span class="string">'char'</span>)
0292         <span class="comment">% Print each cell/string on a different line.</span>
0293         <span class="keyword">for</span> j=1:numel(temp)
0294             fprintf(fout,<span class="string">'%s\n'</span>,temp{j});
0295         <span class="keyword">end</span>
0296     <span class="keyword">else</span>
0297         <span class="comment">% Will automatically print on each line if type is numeric.</span>
0298         fprintf(fout,<span class="string">'%17.15f\n'</span>,temp);
0299     <span class="keyword">end</span>
0300     clear temp;
0301 <span class="keyword">end</span>
0302 
0303 fclose(fout);
0304 <span class="comment">% ==============</span>
0305 <span class="comment">%  End of writefmadata</span>
0306 <span class="comment">% ==============</span>
0307 
0308 
0309 <span class="comment">% ==============</span>
0310 <span class="comment">%  Perform FM analysis</span>
0311 <span class="comment">% ==============</span>
0312 <a name="_sub3" href="#_subfunctions" class="code">function [fma, status] = analysis(varargin)</a>
0313 
0314 status = 1;
0315 
0316 <span class="comment">% Parse the input. The first has to be either a struct with the FMA data or</span>
0317 <span class="comment">% the filename to the file that contains it.</span>
0318 fma = varargin{1};
0319 
0320 boundary = 0;
0321 useTHERING = 0;
0322 <span class="keyword">if</span> nargin &gt; 1
0323     <span class="keyword">for</span> i=nargin:-1:2
0324         <span class="keyword">if</span> ischar(varargin{i})
0325             <span class="keyword">switch</span> varargin{i}
0326                 <span class="keyword">case</span> <span class="string">'boundary'</span>
0327                     boundary = 1;
0328                 <span class="keyword">case</span> <span class="string">'useTHERING'</span>
0329                     <span class="keyword">global</span> THERING
0330                     useTHERING = 1;
0331             <span class="keyword">end</span>
0332         <span class="keyword">end</span>
0333     <span class="keyword">end</span>
0334 <span class="keyword">end</span>
0335 
0336 <span class="keyword">if</span> ~isstruct(fma) &amp; ischar(fma)
0337     fprintf(<span class="string">'\nOpening FMA input file for reading: %s\n'</span>, fma);
0338     [fma readstatus] = <a href="fma_lib.html" class="code" title="function varargout = fma_lib(varargin)">fma_lib</a>(<span class="string">'read'</span>,fma);
0339     <span class="keyword">if</span> ~readstatus
0340         error(lasterr);
0341         status = 0;
0342         <span class="keyword">return</span>
0343     <span class="keyword">end</span>
0344 <span class="keyword">end</span>
0345 
0346 <span class="comment">% Check if datadir exists. If so then go to that directory else stay in the</span>
0347 <span class="comment">% current directory and generate all files here. It should be in the same</span>
0348 <span class="comment">% directory where the input file resides.</span>
0349 <span class="keyword">if</span> ~isempty(fma.datadir) &amp;&amp; exist(fma.datadir,<span class="string">'dir'</span>)
0350     cd(fma.datadir);
0351     pwd
0352 <span class="keyword">end</span>
0353 
0354 <span class="keyword">if</span> useTHERING
0355     <span class="keyword">if</span> isempty(whos(<span class="string">'global'</span>,<span class="string">'THERING'</span>))
0356         lasterr(<span class="string">'Lattice file not loaded yet. Can''t find THERING.'</span>);
0357         status = 0;
0358         <span class="keyword">return</span>
0359     <span class="keyword">else</span>
0360         <span class="keyword">global</span> THERING;
0361     <span class="keyword">end</span>
0362 <span class="keyword">else</span>
0363     <span class="comment">% Expects the data file to be either in fma.datadir or have the full</span>
0364     <span class="comment">% path specified. Can lead to portability problems if latter option</span>
0365     <span class="comment">% used.</span>
0366     eval(strtok(fma.latticefile,<span class="string">'.'</span>));
0367 <span class="keyword">end</span>
0368 
0369 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0370 <span class="comment">% BEGIN CALCULATIONS</span>
0371 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0372 [temp1, resfilename, temp2] = fileparts(fma.resultsfile);
0373 
0374 t0 = clock;
0375 fma.starttime = datestr(t0,31);
0376 startindex = fma.data.curr;
0377 
0378 <span class="comment">% Create an array containing the index points that we want to calculate and</span>
0379 <span class="comment">% at which point we want to update progress printouts and output data into</span>
0380 <span class="comment">% files.</span>
0381 <span class="keyword">if</span> boundary
0382     tocalculate = find(fma.data.x(startindex:end) &lt; fma.mesh.x(3)/1000 |<span class="keyword">...</span>
0383                        fma.data.y(startindex:end) &lt; fma.mesh.y(3)/1000);
0384 <span class="keyword">else</span>
0385     tocalculate = startindex:fma.data.max;
0386 <span class="keyword">end</span>
0387 
0388 <span class="comment">% Save every [updateinc] hours and the next autosave is in [time2update]</span>
0389 <span class="comment">% hour(s) time.</span>
0390 updateinc = 0.5; <span class="comment">%2.777777777777778e-004; % Update every hour</span>
0391 time2update = 0.5; <span class="comment">%2.777777777777778e-004; % Initial update</span>
0392 <span class="comment">% Create autosave directory</span>
0393 mkdir autosave;
0394 
0395 fprintf(<span class="string">'\n********************\n'</span>);
0396 fprintf(<span class="string">'Beginning calculations... using the following files and parameters:\n'</span>);
0397 fprintf(<span class="string">'Wrorking DIR: %s\n'</span>,fma.datadir);
0398 fprintf(<span class="string">'Total particles to track: %d\n'</span>,fma.data.max);
0399 fprintf(<span class="string">'Number of turns to evaluate: %d %d\n'</span>,fma.nturn1, fma.nturn2);
0400 fprintf(<span class="string">'Comments: %s\n'</span>,fma.comments);
0401 fprintf(<span class="string">'Flags -&gt; boundary   = %d\n'</span>,boundary);
0402 fprintf(<span class="string">'Flags -&gt; useTHERING = %d\n'</span>,useTHERING);
0403 
0404 <span class="keyword">switch</span> fma.aperture
0405     <span class="keyword">case</span> <span class="string">'Transverse'</span>
0406         horiz_ind = 1;
0407         vert_ind = 3;
0408     <span class="keyword">case</span> <span class="string">'Momentum'</span>
0409         horiz_ind = 5;
0410         vert_ind = 1;
0411 <span class="keyword">end</span>
0412 
0413 <span class="keyword">for</span> i=tocalculate
0414     fma.data.curr = i;
0415     
0416     <span class="comment">% Calculate first set of orbits and tunes</span>
0417     partpos = zeros(6,1);
0418     partpos(horiz_ind) = fma.data.x(i);
0419     partpos(vert_ind) = fma.data.y(i);
0420     <span class="keyword">if</span> exist(<span class="string">'atversion.m'</span>,<span class="string">'file'</span>)
0421         [T lost] = ringpass(THERING,partpos,fma.nturn1);
0422     <span class="keyword">else</span>
0423         [T lost] = ringpass2(THERING,partpos,fma.nturn1);
0424     <span class="keyword">end</span>
0425     <span class="keyword">if</span> ~lost
0426         xorb = complex(T(1,1:end),-T(2,1:end));
0427         yorb = complex(T(3,1:end),-T(4,1:end));
0428         fma.data.nux1(i) = <a href="#_sub4" class="code" title="subfunction varargout = local_freqsearch(data, varargin)">local_freqsearch</a>(xorb);
0429         fma.data.nuy1(i) = <a href="#_sub4" class="code" title="subfunction varargout = local_freqsearch(data, varargin)">local_freqsearch</a>(yorb);
0430 
0431         <span class="comment">% DEBUG</span>
0432         <span class="comment">%         fprintf('%15.13f %15.13f', xtune(1,ind), ytune(1,ind));</span>
0433         <span class="comment">%         return</span>
0434 
0435         <span class="comment">% Calculate remaining turns for diffusion calculations</span>
0436         <span class="keyword">if</span> exist(<span class="string">'atversion.m'</span>,<span class="string">'file'</span>)
0437             [T lost] = ringpass(THERING,T(:,end),fma.nturn2);
0438         <span class="keyword">else</span>
0439             [T lost] = ringpass2(THERING,T(:,end),fma.nturn2); <span class="comment">% turn by turn tracking</span>
0440         <span class="keyword">end</span>
0441         <span class="keyword">if</span> ~lost
0442             xorb = complex(T(1,1:end),-T(2,1:end));
0443             yorb = complex(T(3,1:end),-T(4,1:end));
0444             fma.data.nux2(i) = <a href="#_sub4" class="code" title="subfunction varargout = local_freqsearch(data, varargin)">local_freqsearch</a>(xorb);
0445             fma.data.nuy2(i) = <a href="#_sub4" class="code" title="subfunction varargout = local_freqsearch(data, varargin)">local_freqsearch</a>(yorb);
0446 
0447             <span class="comment">% Calculate the diffusion index</span>
0448             fma.data.dindex(i) = sqrt((fma.data.nux2(i) - fma.data.nux1(i))^2 +<span class="keyword">...</span>
0449                 (fma.data.nuy2(i) - fma.data.nuy1(i))^2);
0450         <span class="keyword">end</span>
0451     <span class="keyword">end</span>
0452 
0453     <span class="keyword">if</span> (etime(clock,t0)/3600) &gt; time2update
0454         fma.totaltime = etime(clock,t0)/3600; <span class="comment">% In hours</span>
0455         <span class="comment">% Print status in default output window.</span>
0456         fprintf(<span class="string">'\nSimulation started at %s\n'</span>,fma.starttime);
0457         fprintf(<span class="string">'Progress printed at %s\n'</span>,datestr(clock,31));
0458         fprintf(<span class="string">'=== %5.2f %% completed ===\n'</span>, i/fma.data.max*100);
0459         fprintf(<span class="string">'%d out of %d particles computed in %f hours.\n\n'</span>, i, fma.data.max,fma.totaltime);
0460         <span class="comment">% Write data to file in case something goes wrong and for progress</span>
0461         <span class="comment">% plots.</span>
0462         fma.endtime = datestr(clock,31);
0463         cd autosave;
0464         <a href="#_sub2" class="code" title="subfunction varargout = writefmadata(filename, fma)">writefmadata</a>([resfilename <span class="string">'_'</span> strrep(datestr(now,13),<span class="string">':'</span>,<span class="string">'_'</span>) <span class="string">'.dat'</span>],fma);
0465         cd ..;
0466         
0467         <span class="comment">% Next update of progress</span>
0468         time2update = time2update + updateinc;
0469     <span class="keyword">end</span>
0470     
0471 <span class="keyword">end</span>
0472 
0473 <span class="comment">%% Finished!!!</span>
0474 fma.totaltime = etime(clock,t0)/3600;
0475 fma.endtime = datestr(clock,31);
0476 <a href="#_sub2" class="code" title="subfunction varargout = writefmadata(filename, fma)">writefmadata</a>(fma.resultsfile,fma);
0477 
0478 fprintf(<span class="string">'\n\n ************* FINISHED CALCULATIONS *************\n'</span>);
0479 
0480 
0481 
0482 <a name="_sub4" href="#_subfunctions" class="code">function varargout = local_freqsearch(data, varargin)</a>
0483 <span class="comment">% =========================================================================</span>
0484 <span class="comment">% Find the dominant frequency in the data set.</span>
0485 <span class="comment">%   FREQ = LOCAL_FREQSEARCH(DATA, [RANGE, DT, TOLERANCE, SEARCHWINDOW])</span>
0486 <span class="comment">%</span>
0487 <span class="comment">% RANGE : is the range of the TUNE ie. normalised to 2pi.</span>
0488 
0489 MINIT = 6;
0490 MAXIT = 23;
0491 initSigmaLen = 1000;
0492 
0493 <span class="comment">% Tune range</span>
0494 <span class="keyword">if</span> nargin &gt;= 2
0495     range = varargin{1};
0496 <span class="keyword">else</span>
0497     range = [0 1];
0498 <span class="keyword">end</span>
0499 
0500 <span class="keyword">if</span> nargin &gt;= 3
0501     dt = varargin{2};
0502 <span class="keyword">else</span>
0503     dt = 1;
0504 <span class="keyword">end</span>
0505 
0506 <span class="keyword">if</span> nargin &gt;= 4
0507     tolerance = varargin{3};
0508 <span class="keyword">else</span>
0509     tolerance = 1e-9;
0510 <span class="keyword">end</span>
0511 
0512 <span class="comment">% Determines how much to zoom in when narrowing the search.</span>
0513 <span class="keyword">if</span> nargin &gt;= 5
0514     searchwindow = varargin{4};
0515 <span class="keyword">else</span>
0516     searchwindow = 0.05;
0517 <span class="keyword">end</span>
0518 
0519 
0520 <span class="comment">% Define the time or running parameter against which to calculate the</span>
0521 <span class="comment">% omega.</span>
0522 neval = length(data);
0523 T2 = dt*(neval-1)/2;  <span class="comment">%-T/2 --&gt; T/2</span>
0524 t = -T2:dt:T2;
0525 
0526 <span class="comment">% Will scan this range of frequency.</span>
0527 sigma = [range(1):(range(2)-range(1))/initSigmaLen:range(2)]*2*pi;
0528 
0529 <span class="comment">% Window function that increases hight of the fundamental peak to make it</span>
0530 <span class="comment">% easier to pickout.</span>
0531 p = 1; <span class="comment">% cosine window order</span>
0532 kai = complex( 2^p*(factorial(p))^2*(1+cos(pi*(t/T2))).^p/factorial(2*p) );
0533 
0534 <span class="comment">% This is the spectrum/frequency scan.</span>
0535 psi = zeros(1,length(sigma));
0536 freq = zeros(1,MAXIT);
0537 
0538 <span class="comment">% Some initial variables.</span>
0539 freq(1) = median(sigma);
0540 difference = 1;
0541 j = 2;
0542 
0543 <span class="comment">% determine the frequency spectrum</span>
0544 <span class="keyword">while</span> difference &gt; tolerance || j &lt;= MINIT
0545     <span class="keyword">if</span> j &gt;= MAXIT
0546         <span class="keyword">break</span>
0547     <span class="keyword">end</span>
0548     <span class="comment">% Do the integral that calculates the average &lt;f(t), e^i*sigma*t&gt;. Not</span>
0549     <span class="comment">% including multiplication of some factors like dt, since we only</span>
0550     <span class="comment">% need to find where psi is a maximum and extract the corresponding</span>
0551     <span class="comment">% sigma. Vectorising this loop does not help, evaluated already.</span>
0552     psi = <a href="#_sub6" class="code" title="subfunction psi = midpointsum1(data,kai,t,sigma)">midpointsum1</a>(data,kai,t,sigma);
0553 
0554     <span class="comment">% Plot the frequency spectrum</span>
0555 <span class="comment">%     if j &gt;= 2 &amp; j &lt;=2</span>
0556 <span class="comment">%         figure; plot(sigma,abs(psi));</span>
0557 <span class="comment">%         xlabel('Sigma / Frequency'); ylabel('Arb. Units');</span>
0558 <span class="comment">%     end</span>
0559     
0560     <span class="comment">% Calculate the value of sigma for the maximum psi. Horizontal</span>
0561     [maxpsi maxind] = max(psi(:));
0562     <span class="comment">% Keep the sign of the maximum sigma found since by using MOD you loose</span>
0563     <span class="comment">% all sign information.</span>
0564     freq(j) = sigma(maxind);
0565 
0566     difference = abs(freq(j) - freq(j-1));
0567     
0568     <span class="comment">% If the 'zero' component dominates, remove the component from the</span>
0569     <span class="comment">% function.</span>
0570 <span class="comment">%     freq(j) = 0;</span>
0571     <span class="keyword">if</span> mod(freq(j),2*pi) ~= 0
0572         <span class="comment">% Find new range to seach, zoom in.</span>
0573         halfwidth = (sigma(end) - sigma(1))*searchwindow; <span class="comment">% fraction of previous range</span>
0574         <span class="keyword">if</span> freq(j) == sigma(1)
0575             lowerbound = freq(j) - halfwidth*2/searchwindow;
0576             upperbound = freq(j);
0577         <span class="keyword">elseif</span> freq(j) == sigma(end)
0578             lowerbound = freq(j);
0579             upperbound = freq(j) + halfwidth*2/searchwindow;
0580         <span class="keyword">else</span>
0581             lowerbound = freq(j) - halfwidth;
0582             upperbound = freq(j) + halfwidth;
0583         <span class="keyword">end</span>
0584 <span class="comment">%         sigmalen = length(sigma);</span>
0585 <span class="comment">%         clear sigma;</span>
0586         sigma = [lowerbound:(upperbound-lowerbound)/40:upperbound];
0587         <span class="keyword">if</span> length(sigma) ~= length(psi)
0588             <span class="comment">% Resize psi since initial sigma is 1000 while subsequent</span>
0589             <span class="comment">% devisions are smaller.</span>
0590             clear psi
0591             psi = zeros(1,length(sigma));
0592         <span class="keyword">end</span>
0593     <span class="keyword">else</span>
0594         <span class="comment">% Orthogonal projection to determine the coeffients. Since</span>
0595         <span class="comment">% e^i*sigma*t where sigma = 1, means e^i*0*t = 1.</span>
0596 
0597 <span class="comment">%         a = (0.5/T2)*midpointsum(data.*exp(-complex(0,1)*freq(j)*2*pi.*t));</span>
0598 <span class="comment">%         e = exp(complex(0,1)*0.3006877345*2*pi*t);</span>
0599         a = (0.5/T2)*<a href="#_sub5" class="code" title="subfunction fctnsum = midpointsum(fctn)">midpointsum</a>(data);
0600         e = 1;
0601         
0602         <span class="comment">% Subtract the component from 'f' function.</span>
0603         data = data - a*e;
0604     <span class="keyword">end</span>
0605 
0606     j = j + 1;
0607 <span class="keyword">end</span>
0608 <span class="comment">% fprintf('(%g &gt; %g | %f &lt;= %f) &amp; %f &lt;= %f\n',difference,tolerance,j,MINIT,j,MAXIT);</span>
0609 temp = freq(find(freq ~= 0));
0610 varargout{1} = temp(end)/(2*pi);
0611 <span class="comment">% DEBUG</span>
0612 <span class="comment">% fprintf('%i    %17.15g\n',j, difference);</span>
0613 
0614 <span class="comment">% Critical function (computation timewise)</span>
0615 <a name="_sub5" href="#_subfunctions" class="code">function fctnsum = midpointsum(fctn)</a>
0616 
0617 <span class="comment">% [a b] = size(fctn);</span>
0618 <span class="comment">% if a &gt; 1 &amp;&amp; b &gt; 1</span>
0619 <span class="comment">%     disp('SIMSUM only takes a one dimensional function');</span>
0620 <span class="comment">%     fctnsum = 0;</span>
0621 <span class="comment">%     return</span>
0622 <span class="comment">% end</span>
0623 
0624 <span class="comment">% Vectorise the midpoint method of integrating a numerical function.</span>
0625 <span class="comment">% f_n      = [fctn 0];</span>
0626 <span class="comment">% f_nplus1 = [0 fctn];  % shift all the numbers one &quot;space&quot; to the right.</span>
0627 <span class="comment">% midpoints = 0.5*(f_n + f_nplus1);</span>
0628 
0629 midpoints = (fctn(1:end-1) + fctn(2:end));
0630 fctnsum = 0.5*sum(midpoints);
0631 
0632 <span class="comment">% Critical function (computation timewise)</span>
0633 <a name="_sub6" href="#_subfunctions" class="code">function psi = midpointsum1(data,kai,t,sigma)</a>
0634 
0635 len_sigma = 0;
0636 len_sigma = length(sigma);
0637 fctn = zeros(1,length(t));
0638 midpoints = zeros(1,length(t)-1);
0639 temp = data.*kai;
0640 
0641 <span class="keyword">for</span> k=1:len_sigma
0642     fctn = temp.*complex(cos(sigma(k).*t),-sin(sigma(k).*t));
0643     midpoints = (fctn(1:end-1) + fctn(2:end));
0644     psi(k) = 0.5*sum(midpoints);
0645 <span class="keyword">end</span>
0646 
0647 
0648 
0649 
0650 <a name="_sub7" href="#_subfunctions" class="code">function varargout = plotfm(varargin)</a>
0651 
0652 <span class="comment">% Defaults/Init</span>
0653 output = 0;
0654 inputstruct = {}; ninput = 0;
0655 tunediagbounds = [13.1  13.4   5.0   5.3];
0656 workingpoint = [13.29 5.226];
0657 
0658 <span class="keyword">for</span> i=1:nargin
0659     <span class="keyword">if</span> ischar(varargin{i})
0660         <span class="keyword">if</span> strcmpi(varargin{i},<span class="string">'file'</span>)
0661             output = 1;
0662         <span class="keyword">else</span>
0663             <span class="comment">% Assumes that the string input is a filename.</span>
0664             ninput = ninput + 1;
0665             inputstruct{ninput} = <a href="fma_lib.html" class="code" title="function varargout = fma_lib(varargin)">fma_lib</a>(<span class="string">'read'</span>,varargin{i});
0666         <span class="keyword">end</span>
0667     <span class="keyword">elseif</span> isstruct(varargin{i})
0668         ninput = ninput + 1;
0669         inputstruct{ninput} = varargin{i};
0670     <span class="keyword">elseif</span> isnumeric(varargin{i}) &amp;&amp; length(varargin{i}) == 4
0671         tunediagbounds = varargin{i};
0672     <span class="keyword">elseif</span> isnumeric(varargin{i}) &amp;&amp; length(varargin{i}) == 2
0673         workingpoint = varargin{i};
0674     <span class="keyword">else</span>
0675         fprintf(<span class="string">'\nInput parameter number %d not recognised'</span>,i);
0676     <span class="keyword">end</span>
0677 <span class="keyword">end</span>
0678 
0679 h_coor = figure;
0680 h_freq = figure;
0681 
0682 nrows = floor(sqrt(ninput));
0683 ncols = ceil(ninput/nrows);
0684 
0685 <span class="keyword">for</span> i=1:ninput
0686     fma = inputstruct{i};
0687     
0688     <span class="comment">% Log of zero is undefined, so make it a really small number 1e-19.</span>
0689     fma.data.dindex(find(fma.data.dindex == 0)) = 1e-19;
0690 
0691     <span class="comment">% Plot dynamic aperture in coordinate space where the colour scale has</span>
0692     <span class="comment">% been indexed by the diffusion index.</span>
0693     figure(h_coor); subplot(nrows,ncols,i);
0694     m = length(fma.mesh.y);
0695     n = length(fma.mesh.x);
0696     
0697     <span class="comment">% Check if the definition of the mesh intervals are sorted. Older</span>
0698     <span class="comment">% versions of the code that generated the FMA input files did not sort</span>
0699     <span class="comment">% this and it led to problems when plotting results using SURFACE.</span>
0700     [val minindx] = min(fma.mesh.x);
0701     [val maxindx] = max(fma.mesh.x);
0702     [val minindy] = min(fma.mesh.y);
0703     [val maxindy] = max(fma.mesh.y);
0704     <span class="keyword">if</span> minindx ~= 1 || maxindx ~= n || minindy ~= 1 || maxindy ~= m
0705         <span class="comment">% Sort the mesh intervals</span>
0706         temp = zeros(m,n);
0707         temp = log10(reshape(fma.data.dindex,m,n));
0708         [sortedx xind] = sort(fma.mesh.x);
0709         [sortedy yind] = sort(fma.mesh.y);
0710         surface(sortedx,sortedy,temp(yind,xind));
0711     <span class="keyword">else</span>
0712         surface(fma.mesh.x, fma.mesh.y, log10(reshape(fma.data.dindex,m,n)));
0713     <span class="keyword">end</span>
0714     title(<span class="string">'Diffusion'</span>);
0715     <span class="keyword">if</span> isfield(fma,<span class="string">'aperture'</span>)
0716         <span class="keyword">switch</span> fma.aperture
0717             <span class="keyword">case</span> <span class="string">'Transverse'</span>
0718                 xlabel(<span class="string">'Horizontal Displacement (mm)'</span>)
0719                 ylabel(<span class="string">'Vertical Displacement (mm)'</span>)
0720                 axis equal;
0721             <span class="keyword">case</span> <span class="string">'Momentum'</span>
0722                 xlabel(<span class="string">'Momentum (%)'</span>)
0723                 ylabel(<span class="string">'Horizontal Displacement (mm)'</span>)
0724                 axis normal;
0725         <span class="keyword">end</span>
0726     <span class="keyword">else</span>
0727         xlabel(<span class="string">'Horizontal Displacement (mm)'</span>)
0728         ylabel(<span class="string">'Vertical Displacement (mm)'</span>)
0729         axis equal;
0730     <span class="keyword">end</span>
0731     set(gca,<span class="string">'XLim'</span>,[0.0 1.1*max(fma.mesh.x)]);
0732     set(gca,<span class="string">'YLim'</span>,[0.0 1.1*max(fma.mesh.y)]);
0733     shading flat; 
0734     caxis([-12 -0.17]);
0735 
0736     nux = fma.data.nux2+13;
0737     nux(find(nux &gt; 13.5)) = nux(find(nux &gt; 13.5))-1;
0738     nuy = fma.data.nuy2+5;
0739     nuy(find(nuy &gt; 5.5)) = nuy(find(nuy &gt; 5.5))-1;
0740 
0741     figure(h_freq); subplot(nrows,ncols,i);
0742     plottunediag(7,1, [12.95 13.55 4.95 6.05],workingpoint,<span class="string">'-nospawn'</span>);<span class="comment">%9,14</span>
0743     hold on;
0744     title(<span class="string">''</span>);
0745     scatter(nux, nuy, 5, log10(fma.data.dindex),<span class="string">'filled'</span>);
0746     axis square; 
0747     caxis([-12 -0.17]);
0748     axis(tunediagbounds);
0749 <span class="keyword">end</span>
0750 
0751 <span class="keyword">if</span> output
0752     print(h_coor,<span class="string">'-depsc2'</span>,sprintf(<span class="string">'dynamic_aperture_%s.eps'</span>,fma.aperture));
0753 <span class="keyword">end</span>
0754 <span class="keyword">if</span> output
0755     print(h_freq,<span class="string">'-depsc2'</span>,sprintf(<span class="string">'frequency_map_%s.eps'</span>,fma.aperture));
0756 <span class="keyword">end</span>
0757 handles.difhandle = h_coor;
0758 handles.tunehandle= h_freq;
0759 
0760 varargout{1} = handles;
0761 
0762 
0763 
0764 
0765 <a name="_sub8" href="#_subfunctions" class="code">function varargout = fma_points_around_resonance(a,b,c,periodicity,maxd,varargin)</a>
0766 <span class="comment">% Function will plot only the orbits that have tunes along the resonance</span>
0767 <span class="comment">% line defined by a, b and c up to a maximum perpendicular deviation of</span>
0768 <span class="comment">% maxd from the line. Can either specify the filename containing the FM</span>
0769 <span class="comment">% data or the data struct.</span>
0770 
0771 <span class="comment">% Resonance line a*nu_x + b*nu_y = c*14 where 14 is the periodicity of the</span>
0772 <span class="comment">% ASP lattice.</span>
0773 
0774 ninput = 0;
0775 inputstruct = {};
0776 <span class="keyword">for</span> i=1:nargin-5
0777     <span class="keyword">if</span> ischar(varargin{i})
0778         <span class="keyword">if</span> strcmpi(varargin{i},<span class="string">'file'</span>)
0779             output = 1;
0780         <span class="keyword">else</span>
0781             <span class="comment">% Assumes that the string input is a filename.</span>
0782             ninput = ninput + 1;
0783             inputstruct{ninput} = <a href="fma_lib.html" class="code" title="function varargout = fma_lib(varargin)">fma_lib</a>(<span class="string">'read'</span>,varargin{i});
0784         <span class="keyword">end</span>
0785     <span class="keyword">elseif</span> isstruct(varargin{i})
0786         ninput = ninput + 1;
0787         inputstruct{ninput} = varargin{i};
0788     <span class="keyword">else</span>
0789         fprintf(<span class="string">'\nInput parameter number %d not recognised'</span>,i);
0790     <span class="keyword">end</span>
0791 <span class="keyword">end</span>
0792 
0793 
0794 <span class="keyword">for</span> i=1:ninput
0795     fma = inputstruct{i};
0796     
0797     <span class="comment">% Log of zero is undefined, so make it a really small number 1e-19.</span>
0798     fma.data.dindex(fma.data.dindex == 0) = 1e-19;
0799 
0800     ind = []; nind = 0;
0801     <span class="keyword">for</span> i=1:length(fma.data.x)
0802         <span class="comment">% Only plot region around resonance line specified above.</span>
0803         <span class="keyword">if</span> abs(a*(13 + fma.data.nux2(i)) + b*(5 + fma.data.nuy2(i)) - c*periodicity)/sqrt(a^2 + b^2) &lt; maxd
0804             nind = nind + 1;
0805             ind(nind) = i;
0806         <span class="keyword">else</span>
0807             fma.data.dindex(i) = NaN;
0808         <span class="keyword">end</span>
0809     <span class="keyword">end</span>
0810 
0811     figure; subplot(2,1,1);
0812     m = length(fma.mesh.y);
0813     n = length(fma.mesh.x);
0814     
0815     <span class="comment">% Check if the definition of the mesh intervals are sorted. Older</span>
0816     <span class="comment">% versions of the code that generated the FMA input files did not sort</span>
0817     <span class="comment">% this and it led to problems when plotting results using SURFACE.</span>
0818     [val minindx] = min(fma.mesh.x);
0819     [val maxindx] = max(fma.mesh.x);
0820     [val minindy] = min(fma.mesh.y);
0821     [val maxindy] = max(fma.mesh.y);
0822     <span class="keyword">if</span> minindx ~= 1 || maxindx ~= n || minindy ~= 1 || maxindy ~= m
0823         <span class="comment">% Sort the mesh intervals</span>
0824         temp = zeros(m,n);
0825         temp = log10(reshape(fma.data.dindex,m,n));
0826         [sortedx xind] = sort(fma.mesh.x);
0827         [sortedy yind] = sort(fma.mesh.y);
0828         surface(sortedx,sortedy,temp(yind,xind));
0829     <span class="keyword">else</span>
0830         surface(fma.mesh.x, fma.mesh.y, log10(reshape(fma.data.dindex,m,n)));
0831     <span class="keyword">end</span>
0832     title(<span class="string">'Diffusion'</span>);
0833     xlabel(<span class="string">'Horizontal Displacement (mm)'</span>)
0834     ylabel(<span class="string">'Vertical Displacement (mm)'</span>)
0835     axis equal;
0836     set(gca,<span class="string">'XLim'</span>,[0.0 1.1*max(fma.mesh.x)]);
0837     set(gca,<span class="string">'YLim'</span>,[0.0 1.1*max(fma.mesh.y)]);
0838     shading flat; caxis([-12 -0.17]);
0839     <span class="comment">% print(h,'-depsc2',[pre 'dynamic_aperture.eps'])</span>
0840 
0841     subplot(2,1,2);
0842     plottunediag(7,14, [12.95 13.55 4.95 6.05],[13.29 5.216],<span class="string">'-nospawn'</span>);
0843     hold on;
0844     title(<span class="string">''</span>);
0845     scatter(fma.data.nux2+13, fma.data.nuy2+5, 5, log10(fma.data.dindex),<span class="string">'filled'</span>);
0846     axis square; caxis([-12 -0.17]);
0847     axis([13.1  13.4   5.0   5.3]);
0848 <span class="keyword">end</span>
0849 
0850 
0851 <a name="_sub9" href="#_subfunctions" class="code">function varargout = interactive_selection(varargin)</a>
0852 <span class="comment">% Interactively select the points in tunespace and only plot the</span>
0853 <span class="comment">% corresponding points in coordinate space.</span>
0854 
0855 ninput = 0;
0856 inputstruct = {};
0857 <span class="keyword">for</span> i=1:nargin
0858     <span class="keyword">if</span> ischar(varargin{i})
0859         <span class="keyword">if</span> strcmpi(varargin{i},<span class="string">'file'</span>)
0860             output = 1;
0861         <span class="keyword">else</span>
0862             <span class="comment">% Assumes that the string input is a filename.</span>
0863             ninput = ninput + 1;
0864             inputstruct{ninput} = <a href="fma_lib.html" class="code" title="function varargout = fma_lib(varargin)">fma_lib</a>(<span class="string">'read'</span>,varargin{i});
0865         <span class="keyword">end</span>
0866     <span class="keyword">elseif</span> isstruct(varargin{i})
0867         ninput = ninput + 1;
0868         inputstruct{ninput} = varargin{i};
0869     <span class="keyword">else</span>
0870         fprintf(<span class="string">'\nInput parameter number %d not recognised'</span>,i);
0871     <span class="keyword">end</span>
0872 <span class="keyword">end</span>
0873 
0874 <span class="keyword">for</span> i=1:ninput
0875     fma = inputstruct{i};
0876     
0877     <span class="comment">% Log of zero is undefined, so make it a really small number 1e-19.</span>
0878     fma.data.dindex(find(fma.data.dindex == 0)) = 1e-19;
0879 
0880     <span class="comment">% Pick the points that you want to plot. Lasso is a user written utility</span>
0881     <span class="comment">% currently found at the Matlab file exchange area.</span>
0882     temph = figure;
0883     [xtunesel,ytunesel,indsel] = <a href="lasso.html" class="code" title="function [selx,sely,indexnr]=lasso(x,y)">lasso</a>(fma.data.nux2+13, fma.data.nuy2+5);
0884     delete(temph);
0885     <span class="comment">% Discard; Outside polygon</span>
0886     tempdindex = zeros(size(fma.data.dindex));
0887     tempdindex(:) = NaN;
0888     tempdindex(indsel) = fma.data.dindex(indsel);
0889 
0890     figure; subplot(2,1,1);
0891     m = length(fma.mesh.y);
0892     n = length(fma.mesh.x);
0893         
0894     <span class="comment">% Check if the definition of the mesh intervals are sorted. Older</span>
0895     <span class="comment">% versions of the code that generated the FMA input files did not sort</span>
0896     <span class="comment">% this and it led to problems when plotting results using SURFACE.</span>
0897     [val minindx] = min(fma.mesh.x);
0898     [val maxindx] = max(fma.mesh.x);
0899     [val minindy] = min(fma.mesh.y);
0900     [val maxindy] = max(fma.mesh.y);
0901     <span class="keyword">if</span> minindx ~= 1 || maxindx ~= n || minindy ~= 1 || maxindy ~= m
0902         <span class="comment">% Sort the mesh intervals</span>
0903         temp = zeros(m,n);
0904         temp = log10(reshape(tempdindex,m,n));
0905         [sortedx xind] = sort(fma.mesh.x);
0906         [sortedy yind] = sort(fma.mesh.y);
0907         surface(sortedx,sortedy,temp(yind,xind));
0908     <span class="keyword">else</span>
0909         surface(fma.mesh.x, fma.mesh.y, log10(reshape(tempdindex,m,n)));
0910     <span class="keyword">end</span>
0911     title(<span class="string">'Diffusion'</span>);
0912     xlabel(<span class="string">'Horizontal Displacement (m)'</span>)
0913     ylabel(<span class="string">'Vertical Displacement (m)'</span>)
0914     axis equal;
0915     set(gca,<span class="string">'XLim'</span>,[1.1*min(fma.mesh.x) 1.1*max(fma.mesh.x)]);
0916     set(gca,<span class="string">'YLim'</span>,[1.1*min(fma.mesh.y) 1.1*max(fma.mesh.y)]);
0917     shading flat; caxis([-12 -0.17]);
0918     <span class="comment">% print(h,'-depsc2',[pre 'dynamic_aperture.eps'])</span>
0919 
0920     subplot(2,1,2);
0921     plottunediag(5,1, [12.95 13.55 4.95 6.05],[13.3 5.2],<span class="string">'nospawn'</span>);
0922     hold on;
0923     title(<span class="string">''</span>);
0924     scatter(fma.data.nux2+13, fma.data.nuy2+5, 5, log10(tempdindex),<span class="string">'filled'</span>);
0925     axis square; caxis([-12 -0.17]);
0926     axis([13.1  13.4   5.0   5.3]);
0927 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Sun 28-Jul-2013 23:18:56 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>