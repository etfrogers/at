<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of atfrommadx</title>
  <meta name="keywords" content="atfrommadx">
  <meta name="description" content="tansform madX sequence file (savesequence) file into AT lattice structure.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../../index.html">Home</a> &gt;  <a href="../../../index.html">atmat</a> &gt; <a href="../../index.html">pubtools</a> &gt; <a href="#">Converters</a> &gt; <a href="index.html">MADX2AT</a> &gt; atfrommadx.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../../index.html"><img alt="<" border="0" src="../../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for atmat/pubtools/Converters/MADX2AT&nbsp;<img alt=">" border="0" src="../../../../right.png"></a></td></tr></table>-->

<h1>atfrommadx
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>tansform madX sequence file (savesequence) file into AT lattice structure.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>function atfrommadx(seqfilemadX,E0,outfilename) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> tansform madX sequence file (savesequence) file into AT lattice structure.

 This procedure reads a saved lattice (sequence in madx) in madX 
 and converts it to an AT lattice

 (madx comands to save the sequences : 
 
  _______ MADX code _________
  use,period=sequencename1; 
  use,period=sequencename2; 
  use,period=sequencename2; 
  SAVE,FILE='seqfilemadX.seq';
  ___________________________

  seqfilemadX.seq will contain sequencename1 sequencename2 sequencename3 
  in the correct format in a single file
 
 )
 
 The routine outputs a Matlab macro with all the AT defitions and variables as
 in the madX file  

 The order of the declarations is the same in the two files.
 declarations that contain other variables are moved to the end. (this may not be enough)


 Works also with single madX files not containing comands, only
 definitions.

 parameters:
    - seqfilemadX=name of the mad8 lattice file
    - E0  = design energy
    - outfilename (default: seqfilemadX_AT_LATTICE.mat)
    
 default pass methods:
          quadrupoles : StrMPoleSymplectic4Pass
          dipole : BndMPoleSymplectic4Pass
          multipole : StrMPoleSymplectic4Pass
          sextupole : StrMPoleSymplectic4Pass
          thinmultipole : ThinMPolePass
          correctors : ThinMPolePass
          cavity : DriftPass</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>	determines atribute and sets field in sxs{i} structure AT</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function atfrommadx(seqfilemadX,E0,outfilename)</a>
0002 <span class="comment">% tansform madX sequence file (savesequence) file into AT lattice structure.</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% This procedure reads a saved lattice (sequence in madx) in madX</span>
0005 <span class="comment">% and converts it to an AT lattice</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% (madx comands to save the sequences :</span>
0008 <span class="comment">%</span>
0009 <span class="comment">%  _______ MADX code _________</span>
0010 <span class="comment">%  use,period=sequencename1;</span>
0011 <span class="comment">%  use,period=sequencename2;</span>
0012 <span class="comment">%  use,period=sequencename2;</span>
0013 <span class="comment">%  SAVE,FILE='seqfilemadX.seq';</span>
0014 <span class="comment">%  ___________________________</span>
0015 <span class="comment">%</span>
0016 <span class="comment">%  seqfilemadX.seq will contain sequencename1 sequencename2 sequencename3</span>
0017 <span class="comment">%  in the correct format in a single file</span>
0018 <span class="comment">%</span>
0019 <span class="comment">% )</span>
0020 <span class="comment">%</span>
0021 <span class="comment">% The routine outputs a Matlab macro with all the AT defitions and variables as</span>
0022 <span class="comment">% in the madX file</span>
0023 <span class="comment">%</span>
0024 <span class="comment">% The order of the declarations is the same in the two files.</span>
0025 <span class="comment">% declarations that contain other variables are moved to the end. (this may not be enough)</span>
0026 <span class="comment">%</span>
0027 <span class="comment">%</span>
0028 <span class="comment">% Works also with single madX files not containing comands, only</span>
0029 <span class="comment">% definitions.</span>
0030 <span class="comment">%</span>
0031 <span class="comment">% parameters:</span>
0032 <span class="comment">%    - seqfilemadX=name of the mad8 lattice file</span>
0033 <span class="comment">%    - E0  = design energy</span>
0034 <span class="comment">%    - outfilename (default: seqfilemadX_AT_LATTICE.mat)</span>
0035 <span class="comment">%</span>
0036 <span class="comment">% default pass methods:</span>
0037 <span class="comment">%          quadrupoles : StrMPoleSymplectic4Pass</span>
0038 <span class="comment">%          dipole : BndMPoleSymplectic4Pass</span>
0039 <span class="comment">%          multipole : StrMPoleSymplectic4Pass</span>
0040 <span class="comment">%          sextupole : StrMPoleSymplectic4Pass</span>
0041 <span class="comment">%          thinmultipole : ThinMPolePass</span>
0042 <span class="comment">%          correctors : ThinMPolePass</span>
0043 <span class="comment">%          cavity : DriftPass</span>
0044 <span class="comment">%</span>
0045 
0046 <span class="comment">%% changes history</span>
0047 <span class="comment">% created 7-sep-2012 by S.M.Liuzzo @ ESRF</span>
0048 <span class="comment">%</span>
0049 <span class="comment">% updated 12-sep-2012 Cavity DriftPass (not IdentityPass)</span>
0050 <span class="comment">% updated 13-sep-2012 Capital letter names</span>
0051 <span class="comment">%                     CorrectorPass</span>
0052 <span class="comment">%                     _red reduced versions</span>
0053 <span class="comment">% updated 14-sep-2012 multipoles (1/n!) factor from madx to AT</span>
0054 <span class="comment">% updated 21-dec-2012 rbend-sbend length conversion corrected</span>
0055 <span class="comment">% updated 05-mar-2013 lattice output no fringes and with fringes (_FF).</span>
0056 <span class="comment">%</span>
0057 <span class="comment">% updated 20-mar-2013 removed output no fringes and with fringes (_FF).</span>
0058 <span class="comment">%                     removed output reduced (_red).</span>
0059 <span class="comment">%                     use atconstructors.</span>
0060 <span class="comment">%                     call macro directly</span>
0061 <span class="comment">%                     try-catch macro running</span>
0062 <span class="comment">%                     tempname file and fulfile.</span>
0063                   
0064 
0065 <span class="comment">%% initial warnings</span>
0066 disp(<span class="string">'important notice about conversion:'</span>)
0067 disp(<span class="string">''</span>);
0068 disp([<span class="string">'1) THE MADX FILE MUST BE OUTPUT OF save, file=seqfilemadX;'</span><span class="keyword">...</span>
0069     <span class="string">' THIS GARANTES AN APPROPRIATE FILE FORMAT'</span>]);
0070 disp(<span class="string">''</span>);
0071 disp([<span class="string">'2) THE MADX PROGRAM allows to use variable not previously defined.'</span><span class="keyword">...</span>
0072     <span class="string">' This is not known to AT!.'</span><span class="keyword">...</span>
0073     <span class="string">' If the program fails but generates a ..._macro.m file, '</span><span class="keyword">...</span>
0074     <span class="string">' please edit this file reordering the declarations and run it.'</span>]);
0075 disp(<span class="string">''</span>);
0076 disp([<span class="string">'3) If periodname is not specified'</span> <span class="keyword">...</span>
0077     <span class="string">' It is assumed the name of the file (up to the .) '</span> <span class="keyword">...</span>
0078     <span class="string">'to be the sequence name that you want to use'</span>]);
0079 
0080 <span class="comment">%% open madX sequence file</span>
0081 sX=fopen(seqfilemadX,<span class="string">'r'</span>);
0082 
0083 <span class="comment">% the : detect definitions. every : is preceded by a name</span>
0084 <span class="comment">% of an element.</span>
0085 <span class="comment">% between two : all the parameter of an elemetn or a line ar found.</span>
0086 
0087 <span class="comment">%% get madX file in a cell array with a new elment at every space comma or new line.</span>
0088 SXCELL=textscan(sX,<span class="string">'%s'</span>,<span class="string">'delimiter'</span>,<span class="string">';'</span>);
0089 
0090 SXSTRING=SXCELL{1}; <span class="comment">% still a cell array but every space or new line now is stored as a new cell.</span>
0091 
0092 <span class="comment">% scroll and reshape to divide atributes</span>
0093 tmp={};
0094 
0095 <span class="keyword">for</span> i=1:length(SXSTRING)
0096     SXSTRING{i}=strrep(SXSTRING{i},<span class="string">' '</span>,<span class="string">''</span>); <span class="comment">% no spaces</span>
0097     SXSTRING{i}=strrep(SXSTRING{i},<span class="string">':='</span>,<span class="string">'='</span>);
0098     SXSTRING{i}=strrep(SXSTRING{i},<span class="string">';'</span>,<span class="string">''</span>);
0099     
0100     c=[1 sort([strfind(SXSTRING{i},<span class="string">','</span>) strfind(SXSTRING{i},<span class="string">':'</span>)<span class="keyword">...</span>
0101                      strfind(SXSTRING{i},<span class="string">'='</span>)]) length(SXSTRING{i})];
0102     
0103     <span class="keyword">for</span> jc=1:length(c)-1
0104         <span class="keyword">if</span> jc==1
0105             tmp=[tmp SXSTRING{i}(c(jc):c(jc+1))];
0106         <span class="keyword">else</span>
0107             tmp=[tmp SXSTRING{i}(c(jc)+1:c(jc+1))];
0108         <span class="keyword">end</span>
0109     <span class="keyword">end</span>
0110     
0111 <span class="keyword">end</span>
0112 SXSTRING=tmp;
0113 
0114 
0115 <span class="comment">%% open .m file to output matlab translated code</span>
0116 
0117 filemacroname=[tempname <span class="string">'.m'</span>];
0118 
0119 mafileout=fopen(filemacroname,<span class="string">'w+'</span>);
0120 mst=[<span class="string">'%% this is a macro that converts to AT the madX lattice: '</span><span class="keyword">...</span>
0121                      seqfilemadX <span class="string">'\n%%\n%% Created: '</span> datestr(now)<span class="keyword">...</span>
0122                      <span class="string">'\n%%\n%%\n\nglobal GLOBVAL;\nGLOBVAL.E0='</span> num2str(E0)<span class="keyword">...</span>
0123                      <span class="string">';\n\n\n'</span>];
0124 def=[<span class="string">'\n\n%%%% DEFINITIONS \n\n'</span>]; <span class="comment">%#ok&lt;*NBRAK&gt;</span>
0125 lines=[<span class="string">'\n\n%%%% LINES \n\n'</span>];
0126 var=[<span class="string">'%%%% VARIABLES \n\n sxt_on=1;'</span>];
0127 formulas=[<span class="string">'\n\n%%%% RELATIONS \n\n'</span>];
0128 
0129 <span class="comment">%% convert to a matlab macro</span>
0130 j=1; <span class="comment">% used in line block counter (element atributes counter)</span>
0131 
0132 elemcount=0;
0133 i=1; <span class="comment">% skip header in mad8 file   (element counter)</span>
0134 <span class="keyword">while</span> i&lt;length(SXSTRING)-2
0135     
0136     <span class="keyword">if</span> SXSTRING{i}(end)==<span class="string">':'</span> <span class="comment">% new element or line</span>
0137         def=[ def <span class="keyword">...</span>
0138             ]; <span class="comment">%#ok&lt;*AGROW&gt; % end line and go to newline add name</span>
0139         SXSTRING{i}(1:end-1)=upper(SXSTRING{i}(1:end-1));
0140         
0141         SXSTRING{i+j}=strrep(SXSTRING{i+j},<span class="string">'MARKER'</span>,<span class="string">'MARKER,'</span>);
0142         SXSTRING{i+j}=strrep(SXSTRING{i+j},<span class="string">'MARKER,,'</span>,<span class="string">'MARKER,'</span>);
0143         SXSTRING{i+j}=strrep(SXSTRING{i+j},<span class="string">'KICKER'</span>,<span class="string">'KICKER,'</span>);
0144         SXSTRING{i+j}=strrep(SXSTRING{i+j},<span class="string">'KICKER,,'</span>,<span class="string">'KICKER,'</span>);
0145         SXSTRING{i+j}=strrep(SXSTRING{i+j},<span class="string">'MONITOR'</span>,<span class="string">'MONITOR,'</span>);
0146         SXSTRING{i+j}=strrep(SXSTRING{i+j},<span class="string">'MONITOR,,'</span>,<span class="string">'MONITOR,'</span>);
0147         
0148         ElementType=SXSTRING{i+j}(1:end-1);
0149         <span class="comment">%  THERING=[THERING ' ' SXSTRING{i+1}];</span>
0150         <span class="comment">%j=2;</span>
0151         nwel=SXSTRING{i+j}(end);
0152       
0153         <span class="keyword">switch</span> ElementType
0154             <span class="keyword">case</span> {<span class="string">'quadrupole'</span>,<span class="string">'QUADRUPOLE'</span>, <span class="string">'QUADRUPO'</span>}
0155                 def=[def <span class="string">'\n'</span>];
0156                 def=[ def <span class="keyword">...</span>
0157                     SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0158                     <span class="string">'=atquadrupole('''</span><span class="keyword">...</span>
0159                     SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0160                     <span class="string">''',0,0,''StrMPoleSymplectic4Pass'');\n'</span><span class="keyword">...</span>
0161                     ];
0162                 
0163                 
0164                 elemcount=elemcount+1;
0165                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0166                     def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),SXSTRING{i+j},SXSTRING{i+j+1});
0167                    
0168                     j=j+1; <span class="comment">%go to new atribute</span>
0169                     nwel=SXSTRING{i+j}(end);
0170                 <span class="keyword">end</span>
0171                 
0172             <span class="keyword">case</span> {<span class="string">'sextupole'</span>,<span class="string">'SEXTUPOLE'</span>}
0173                 def=[def <span class="string">'\n'</span>];
0174                 def=[ def <span class="keyword">...</span>
0175                     SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0176                     <span class="string">'=atsextupole('''</span><span class="keyword">...</span>
0177                     SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0178                     <span class="string">''',0,0,''StrMPoleSymplectic4Pass'');\n'</span><span class="keyword">...</span>
0179                     ];
0180                 
0181                 
0182                 elemcount=elemcount+1;
0183                 
0184                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0185                     def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),SXSTRING{i+j},SXSTRING{i+j+1});
0186                     
0187                     j=j+1; <span class="comment">%go to new atribute</span>
0188                     nwel=SXSTRING{i+j}(end);
0189                 <span class="keyword">end</span>
0190                 def=[ def <span class="keyword">...</span>
0191                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomB'')='</span> SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomB'')*1/2'</span> <span class="string">';\n'</span> <span class="keyword">...</span>
0192                 ];
0193                 
0194             <span class="keyword">case</span> {<span class="string">'rbend'</span>,<span class="string">'RBEND'</span>}
0195                 
0196                 def=[def <span class="string">'\n'</span>];
0197                
0198                 def=[ def <span class="keyword">...</span>
0199                     SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0200                     <span class="string">'=atrbend('''</span><span class="keyword">...</span>
0201                     SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0202                     <span class="string">''',0,0,0,''BndMPoleSymplectic4Pass'');\n'</span><span class="keyword">...</span>
0203                     ];
0204                 
0205                 
0206                 elemcount=elemcount+1;
0207                 
0208                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0209                     def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),SXSTRING{i+j},SXSTRING{i+j+1});
0210                     
0211                     j=j+1; <span class="comment">%go to new atribute</span>
0212                     nwel=SXSTRING{i+j}(end);
0213                 <span class="keyword">end</span>
0214                 <span class="comment">% bendings are  sector by default. change to rectangular</span>
0215                 def=[ def <span class="keyword">...</span>
0216                  SXSTRING{i}(1:end-1) <span class="string">'.(''EntranceAngle'')='</span> SXSTRING{i}(1:end-1) <span class="string">'.(''EntranceAngle'')+'</span> SXSTRING{i}(1:end-1) <span class="string">'.(''BendingAngle'')/2; \n'</span><span class="keyword">...</span>
0217                  SXSTRING{i}(1:end-1) <span class="string">'.(''ExitAngle'')='</span> SXSTRING{i}(1:end-1) <span class="string">'.(''ExitAngle'')+'</span> SXSTRING{i}(1:end-1) <span class="string">'.(''BendingAngle'')/2; \n'</span><span class="keyword">...</span>
0218                    SXSTRING{i}(1:end-1) <span class="string">'.(''Length'')='</span> SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0219                      <span class="string">'.(''Length'')*('</span> SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0220                      <span class="string">'.(''BendingAngle'')/2)/sin('</span> SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0221                      <span class="string">'.(''BendingAngle'')/2); \n'</span><span class="keyword">...</span>
0222                   ];
0223               
0224             <span class="keyword">case</span> {<span class="string">'sbend'</span>,<span class="string">'SBEND'</span>}
0225                 def=[def <span class="string">'\n'</span>];
0226                 
0227                 def=[ def <span class="keyword">...</span>
0228                     SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0229                     <span class="string">'=atsbend('</span><span class="keyword">...</span>
0230                     <span class="string">''''</span> SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0231                     <span class="string">''',0,0,0,''BndMPoleSymplectic4Pass'');\n'</span><span class="keyword">...</span>
0232                     ];
0233                 
0234                 elemcount=elemcount+1;
0235                 
0236                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0237                     def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),<span class="keyword">...</span>
0238                     SXSTRING{i+j},SXSTRING{i+j+1});
0239                     
0240                     j=j+1; <span class="comment">%go to new atribute</span>
0241                     nwel=SXSTRING{i+j}(end);
0242                 <span class="keyword">end</span>
0243            
0244             <span class="keyword">case</span> {<span class="string">'DRIFT'</span>,<span class="string">'drift'</span>}
0245                 def=[def <span class="string">'\n'</span>];
0246                 
0247                 def=[ def <span class="keyword">...</span>
0248                     SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0249                     <span class="string">'=atdrift('</span><span class="keyword">...</span>
0250                     <span class="string">''''</span> SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0251                     <span class="string">''',0,''DriftPass'');\n'</span><span class="keyword">...</span>
0252                     ];
0253                 
0254                 
0255                 elemcount=elemcount+1;
0256                 
0257                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0258                     def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),<span class="keyword">...</span>
0259                     SXSTRING{i+j},SXSTRING{i+j+1});
0260                     
0261                     j=j+1; <span class="comment">%go to new atribute</span>
0262                     nwel=SXSTRING{i+j}(end);
0263                 <span class="keyword">end</span>
0264             <span class="keyword">case</span> {<span class="string">'RFCAVITY'</span>,<span class="string">'rfcavity'</span>}
0265                 def=[def <span class="string">'\n'</span>];
0266                 
0267                 def=[ def <span class="keyword">...</span>
0268                     SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0269                     <span class="string">'=atrfcavity('''</span> SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0270                     <span class="string">''',0,0,0,0,'</span> num2str(E0) <span class="keyword">...</span>
0271                     <span class="string">',''DriftPass'');\n'</span><span class="keyword">...</span>
0272                     ];
0273                 
0274                 elemcount=elemcount+1;
0275                 
0276                 
0277                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0278                     def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),<span class="keyword">...</span>
0279                     SXSTRING{i+j},SXSTRING{i+j+1});
0280                     
0281                     j=j+1; <span class="comment">%go to new atribute</span>
0282                     nwel=SXSTRING{i+j}(end);
0283                 <span class="keyword">end</span>
0284             <span class="keyword">case</span> {<span class="string">'MULTIPOLE'</span>,<span class="string">'multipole'</span>}
0285                 <span class="comment">% multipoles should be StrMPoleSymplectic4Pass with short length</span>
0286                 <span class="comment">% to be compatible with MADX</span>
0287                 
0288                 def=[def <span class="string">'\n'</span>];
0289                 
0290                 def=[ def <span class="keyword">...</span>
0291                     SXSTRING{i}(1:end-1) <span class="string">'=atthinmultipole('</span><span class="keyword">...</span>
0292                     <span class="string">''''</span> SXSTRING{i}(1:end-1) <span class="string">''''</span><span class="keyword">...</span>
0293                     <span class="string">',[0 0 0 0],[0 0 0 0],'</span><span class="keyword">...</span>
0294                     <span class="string">'''ThinMPolePass'');\n'</span><span class="keyword">...</span>
0295                      SXSTRING{i}(1:end-1) <span class="string">'.(''Length'')=0; \n'</span><span class="keyword">...</span>
0296                     ];
0297                 
0298                 
0299                 elemcount=elemcount+1;
0300                 <span class="comment">% MADX--&gt;   ocf0: multipole,knl:={ 0, 0, 0,kocf0 };</span>
0301                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0302                     multipoles=[];
0303                     <span class="keyword">if</span> strcmp(SXSTRING{i+j+1}(1),<span class="string">'{'</span>) <span class="comment">% if open paerntesis found</span>
0304                         multipoles=[multipoles <span class="string">'['</span> SXSTRING{i+j+1}(2:end)];
0305                         k=2;
0306                         <span class="keyword">while</span> ~strcmp(SXSTRING{i+j+k}(end),<span class="string">'}'</span>) &amp;&amp; k&lt;10 <span class="comment">% look for closed parentesis</span>
0307                             multipoles=[multipoles SXSTRING{i+j+k}];
0308                             k=k+1;
0309                         <span class="keyword">end</span>
0310                         multipoles=[multipoles SXSTRING{i+j+k}(1:(end-1)) <span class="string">']'</span>];
0311                         
0312                     <span class="keyword">end</span>
0313                     
0314                     def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),<span class="keyword">...</span>
0315                     SXSTRING{i+j},multipoles);
0316                     
0317                     j=j+1; <span class="comment">%go to new atribute</span>
0318                     nwel=SXSTRING{i+j}(end);
0319                 <span class="keyword">end</span>
0320                 def=[ def <span class="keyword">...</span>
0321                     SXSTRING{i}(1:end-1) <span class="string">'.(''MaxOrder'')=numel('</span> <span class="keyword">...</span>
0322                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomB'')'</span> <span class="string">')-1; \n'</span><span class="keyword">...</span><span class="comment">% max order size polynomb -1</span>
0323                     <span class="string">'expansionCoefFixA=1./factorial([1: numel('</span> <span class="keyword">...</span>
0324                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomA''))]-1); \n'</span><span class="keyword">...</span>
0325                     <span class="string">'expansionCoefFixB=1./factorial([1: numel('</span> <span class="keyword">...</span>
0326                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomB''))]-1); \n'</span><span class="keyword">...</span>
0327                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomB'')=('</span> <span class="keyword">...</span>
0328                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomB'')'</span> <span class="string">').*expansionCoefFixB; \n'</span><span class="keyword">...</span>
0329                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomA'')=('</span> <span class="keyword">...</span>
0330                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomA'')'</span> <span class="string">').*expansionCoefFixA; \n'</span><span class="keyword">...</span>
0331                     ];
0332                 
0333             <span class="keyword">case</span> {<span class="string">'OCTUPOLE'</span>,<span class="string">'octupole'</span>}
0334                 def=[def <span class="string">'\n'</span>];
0335                 
0336                 def=[ def <span class="keyword">...</span>
0337                     SXSTRING{i}(1:end-1) <span class="string">'=atmultipole('</span><span class="keyword">...</span>
0338                     <span class="string">''''</span> SXSTRING{i}(1:end-1) <span class="string">''''</span><span class="keyword">...</span>
0339                     <span class="string">',0,[0 0 0 0],[0 0 0 0],'</span><span class="keyword">...</span>
0340                     <span class="string">'''StrMPoleSymplectic4Pass'');\n'</span><span class="keyword">...</span>
0341                     ];
0342                 
0343                 
0344                 elemcount=elemcount+1;
0345                 
0346                 
0347                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0348                     def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),<span class="keyword">...</span>
0349                     SXSTRING{i+j},SXSTRING{i+j+1});
0350                     
0351                     j=j+1; <span class="comment">%go to new atribute</span>
0352                     nwel=SXSTRING{i+j}(end);
0353                 <span class="keyword">end</span>
0354                 
0355                 <span class="comment">% fix madX-AT multipole coefficents</span>
0356                 def=[ def <span class="keyword">...</span>
0357                     SXSTRING{i}(1:end-1) <span class="string">'.(''MaxOrder'')=numel('</span> <span class="keyword">...</span>
0358                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomB'')'</span> <span class="string">')-1; \n'</span><span class="keyword">...</span><span class="comment">% max order size polynomb -1</span>
0359                     <span class="string">'expansionCoefFixA=1./factorial([1: numel('</span> <span class="keyword">...</span>
0360                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomA''))]-1); \n'</span><span class="keyword">...</span>
0361                     <span class="string">'expansionCoefFixB=1./factorial([1: numel('</span> <span class="keyword">...</span>
0362                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomB''))]-1); \n'</span><span class="keyword">...</span>
0363                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomB'')=('</span> <span class="keyword">...</span><span class="comment">.</span>
0364                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomB'')'</span> <span class="string">').*expansionCoefFixB; \n'</span><span class="keyword">...</span>
0365                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomA'')=('</span> <span class="keyword">...</span>
0366                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomA'')'</span> <span class="string">').*expansionCoefFixA; \n'</span><span class="keyword">...</span>
0367                     ];
0368                 
0369             <span class="keyword">case</span> {<span class="string">'SOLENOID'</span>,<span class="string">'solenoid'</span>}
0370                 def=[def <span class="string">'\n'</span>];
0371                 
0372                  def=[ def <span class="keyword">...</span>
0373                     SXSTRING{i}(1:end-1) <span class="string">'=atsolenoid('</span><span class="keyword">...</span>
0374                     <span class="string">''''</span> SXSTRING{i}(1:end-1) <span class="string">''''</span><span class="keyword">...</span>
0375                     <span class="string">',0,0,'</span><span class="keyword">...</span>
0376                     <span class="string">'''IdentityPass'');\n'</span><span class="keyword">...</span>
0377                     ];
0378                 
0379                 
0380                 elemcount=elemcount+1;
0381                 
0382                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0383                     def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),<span class="keyword">...</span>
0384                         SXSTRING{i+j},SXSTRING{i+j+1});
0385                     
0386                     j=j+1; <span class="comment">%go to new atribute</span>
0387                     nwel=SXSTRING{i+j}(end);
0388                 <span class="keyword">end</span>
0389             <span class="keyword">case</span> {<span class="string">'MARKER'</span>,<span class="string">'marker'</span>,<span class="string">'marke'</span>}
0390                 def=[def <span class="string">'\n'</span>];
0391                 
0392                 def=[ def <span class="keyword">...</span>
0393                     SXSTRING{i}(1:end-1) <span class="string">'=atmarker('</span><span class="keyword">...</span>
0394                     <span class="string">''''</span> SXSTRING{i}(1:end-1) <span class="string">''');\n'</span><span class="keyword">...</span>
0395                      SXSTRING{i}(1:end-1) <span class="string">'.(''Length'')=0; \n'</span><span class="keyword">...</span>
0396                     ];
0397                 
0398                 elemcount=elemcount+1;
0399                 
0400                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0401                     def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),<span class="keyword">...</span>
0402                         SXSTRING{i+j},SXSTRING{i+j+1});
0403                     
0404                     j=j+1; <span class="comment">%go to new atribute</span>
0405                     nwel=SXSTRING{i+j}(end);
0406                 <span class="keyword">end</span>
0407             <span class="keyword">case</span> {<span class="string">'MONITOR'</span>,<span class="string">'monitor'</span>,<span class="string">'monito'</span>}
0408                 def=[def <span class="string">'\n'</span>];
0409                 def=[ def <span class="keyword">...</span>
0410                     SXSTRING{i}(1:end-1) <span class="string">'.(''FamName'')='''</span> SXSTRING{i}(1:end-1) <span class="string">''';\n'</span> <span class="keyword">...</span>
0411                     SXSTRING{i}(1:end-1) <span class="string">'.(''Class'')=''Monitor''; \n'</span><span class="keyword">...</span>
0412                     SXSTRING{i}(1:end-1) <span class="string">'.(''BetaCode'')=''PU''; \n'</span><span class="keyword">...</span>
0413                     SXSTRING{i}(1:end-1) <span class="string">'.(''PassMethod'')=''IdentityPass''; \n'</span><span class="keyword">...</span>
0414                     SXSTRING{i}(1:end-1) <span class="string">'.(''MaxOrder'')=1; \n'</span><span class="keyword">...</span>
0415                     SXSTRING{i}(1:end-1) <span class="string">'.(''NumIntSteps'')=2; \n'</span><span class="keyword">...</span>
0416                     SXSTRING{i}(1:end-1) <span class="string">'.(''Length'')=0; \n'</span><span class="keyword">...</span>
0417                     SXSTRING{i}(1:end-1) <span class="string">'.(''Energy'')='</span> num2str(E0) <span class="string">'; \n'</span><span class="keyword">...</span>
0418                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomB'')=zeros(1,4); \n'</span><span class="keyword">...</span>
0419                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomA'')=zeros(1,4); \n'</span><span class="keyword">...</span>
0420                     ];
0421                 elemcount=elemcount+1;
0422                 
0423                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0424                     def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),<span class="keyword">...</span>
0425                         SXSTRING{i+j},SXSTRING{i+j+1});
0426                     
0427                     j=j+1; <span class="comment">%go to new atribute</span>
0428                     nwel=SXSTRING{i+j}(end);
0429                 <span class="keyword">end</span>
0430             <span class="keyword">case</span> {<span class="string">'KICKER'</span>,<span class="string">'hkicker'</span>,<span class="string">'vkicker'</span>,<span class="string">'kicker'</span>}
0431                 
0432                 def=[def <span class="string">'\n'</span>];
0433                 
0434                 def=[ def <span class="keyword">...</span>
0435                     SXSTRING{i}(1:end-1) <span class="string">'=atcorrector('</span><span class="keyword">...</span>
0436                     <span class="string">''''</span> SXSTRING{i}(1:end-1) <span class="string">''''</span><span class="keyword">...</span>
0437                     <span class="string">',0,0,''ThinMPolePass'''</span><span class="keyword">...</span>
0438                     <span class="string">');\n'</span><span class="keyword">...</span>
0439                     SXSTRING{i}(1:end-1) <span class="string">'.(''MaxOrder'')=1; \n'</span><span class="keyword">...</span>
0440                     SXSTRING{i}(1:end-1) <span class="string">'.(''Length'')=0; \n'</span><span class="keyword">...</span>
0441                     SXSTRING{i}(1:end-1) <span class="string">'.(''Energy'')='</span> num2str(E0) <span class="string">'; \n'</span><span class="keyword">...</span>
0442                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomB'')=zeros(1,4); \n'</span><span class="keyword">...</span>
0443                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomA'')=zeros(1,4); \n'</span><span class="keyword">...</span>
0444                     ];
0445                 
0446                 
0447                 elemcount=elemcount+1;
0448                 
0449                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0450                     def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),<span class="keyword">...</span>
0451                         SXSTRING{i+j},SXSTRING{i+j+1});
0452                     
0453                     j=j+1; <span class="comment">%go to new atribute</span>
0454                     nwel=SXSTRING{i+j}(end);
0455                 <span class="keyword">end</span>
0456             <span class="keyword">case</span> {<span class="string">'CONSTAN'</span>,<span class="string">'constant'</span>}
0457                 <span class="comment">% disp('constant')</span>
0458                 
0459                 var=[var SXSTRING{i}(1:end-1) <span class="string">'='</span> SXSTRING{i+3} <span class="string">'; \n '</span>];
0460                 
0461                 j=j+3;
0462             <span class="keyword">case</span> {<span class="string">'sequence'</span>}
0463                 <span class="comment">% next element is the length</span>
0464                 seqname=SXSTRING{i}(1:end-1);
0465                 l=SXSTRING{i+j+2};
0466                 j=j+2+1;
0467                 
0468                 elname=SXSTRING{i+j};
0469                 at=SXSTRING{i+j+1};
0470                 lines=[lines seqname <span class="string">'={'</span>];
0471                 sposstring=[<span class="string">'\n spos=['</span>];
0472                 <span class="comment">%zero=0;</span>
0473                 <span class="comment">%driftcounter=1;</span>
0474                 <span class="keyword">while</span> strcmp(at,<span class="string">'at='</span>) &amp;&amp; ~strcmp(elname,<span class="string">'endsequence'</span>)
0475                     
0476                     elname=SXSTRING{i+j};
0477                     <span class="keyword">if</span> ~strcmp(elname,<span class="string">'endsequence'</span>)
0478                         elname=strrep(elname,<span class="string">','</span>,<span class="string">''</span>);
0479                         at=SXSTRING{i+j+1};
0480                         spos=SXSTRING{i+j+2};
0481                     
0482                         lines=[lines upper(elname) <span class="string">';...\n'</span>];
0483                         sposstring=[sposstring <span class="string">',...\n '</span> num2str(spos)];
0484             
0485                         j=j+3;
0486                     <span class="keyword">else</span>
0487                         j=j+1;
0488                     <span class="keyword">end</span>
0489                 <span class="keyword">end</span>
0490                 lines=[lines <span class="string">'};\n'</span>];
0491                 sposstring=[sposstring <span class="string">'];\n'</span>];
0492                 sposstring(10)=[]; <span class="comment">% remove extra comma</span>
0493                 <span class="comment">% call function that builds sequence from list of elements</span>
0494                 <span class="comment">% and total length of sequence</span>
0495                 lines=[lines sposstring <span class="string">'\n %% BUILD LATTICE \n'</span><span class="keyword">...</span>
0496                     seqname <span class="string">'=buildATLattice('</span> seqname <span class="string">',spos,'</span> l <span class="string">');\n'</span><span class="keyword">...</span>
0497                    <span class="keyword">...</span><span class="comment"> seqname '_red=atreduce(' seqname ');\n'...</span>
0498                    <span class="keyword">...</span><span class="comment"> seqname '_FF=FringeSwitch(' seqname ',1);\n'...</span>
0499                     ];
0500                 
0501             <span class="keyword">otherwise</span>
0502                 disp([<span class="string">'Unknown element type: '</span> ElementType])
0503         <span class="keyword">end</span>
0504         
0505         
0506         
0507     <span class="keyword">else</span> <span class="comment">% variable declaSXSTRING{i}ration??</span>
0508         <span class="keyword">if</span> SXSTRING{i}(1)~=<span class="string">'!'</span>;
0509            
0510             <span class="comment">% in mad8 declaring a variable before using it is not compulsary.</span>
0511             <span class="comment">% check that all definitions are at the begining.</span>
0512             <span class="keyword">if</span> sum(ismember(<span class="string">'ABCDFGHILMNOPQRSTUVZWYK'</span>,SXSTRING{i+2}))&gt;0 
0513                 <span class="comment">% if letters (but E for exponential) then it is a formula</span>
0514                 formulas=[formulas SXSTRING{i} <span class="string">' = '</span> SXSTRING{i+1} <span class="string">'; \n '</span>];
0515             <span class="keyword">else</span>
0516                 var=[var SXSTRING{i} <span class="string">' '</span> SXSTRING{i+1} <span class="string">'; \n '</span>];
0517             <span class="keyword">end</span>
0518             j=2;
0519         <span class="keyword">end</span>
0520     <span class="keyword">end</span> <span class="comment">% if new element</span>
0521     
0522     i=i+j;
0523     j=1;
0524     
0525 <span class="keyword">end</span>
0526 
0527 
0528 
0529 <span class="comment">%% save close and exit</span>
0530 
0531 macroconvertmadXAT=strrep([mst var formulas def lines],<span class="string">';;'</span>,<span class="string">';'</span>);
0532 fprintf(mafileout,macroconvertmadXAT);
0533 
0534 fclose(<span class="string">'all'</span>);
0535 
0536 <span class="comment">%% clean workspace</span>
0537 clear macroconvertmadXAT formulas def lines var mst 
0538 clear SXSTRING i j SXCELL elemcount ElementType elname
0539 
0540 <span class="comment">%% run macro file and save workspace.</span>
0541 
0542 <span class="comment">%remove file extension</span>
0543 dotplace=strfind(seqfilemadX,<span class="string">'.'</span>);
0544 <span class="keyword">if</span> ~isempty(dotplace)
0545     seqfilemadX=seqfilemadX(1:dotplace-1);
0546 <span class="keyword">end</span>
0547 
0548    
0549 
0550 <span class="keyword">try</span> <span class="comment">% try to run the macro generated</span>
0551     <span class="comment">%%%!!!!! THIS COMAND MAY FAIL! CHECK THE ORDER OF THE DECLARATIONS IN MADX!</span>
0552     run(filemacroname)
0553 
0554     <span class="keyword">if</span> nargin&lt;3
0555         save([seqfilemadX <span class="string">'_AT_LATTICE'</span>]);
0556     <span class="keyword">else</span>
0557         save(outfilename);
0558     <span class="keyword">end</span>
0559     
0560     delete(filemacroname);
0561     
0562 <span class="keyword">catch</span> <span class="comment">%#ok&lt;CTCH&gt;</span>
0563     
0564     fileoutname=[seqfilemadX <span class="string">'_AT_macro.m'</span>];
0565     
0566     movefile(filemacroname,fileoutname);
0567     
0568     disp([<span class="string">'saved macro in : '</span> fileoutname]);
0569     
0570     error([<span class="string">'could not run the macro file.'</span><span class="keyword">...</span>
0571         <span class="string">' It is now in your current directory.'</span><span class="keyword">...</span>
0572         <span class="string">' Please check the order of the definitions'</span>]);
0573 <span class="keyword">end</span>
0574 
0575 fclose(<span class="string">'all'</span>);
0576 
0577 <span class="keyword">return</span></pre></div>
<hr><address>Generated on Sun 28-Jul-2013 23:18:56 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>