<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of calcmisalign</title>
  <meta name="keywords" content="calcmisalign">
  <meta name="description" content="CALCMISALIGN will load the misalign data from the base application user">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">atmat</a> &gt; <a href="../index.html">pubtools</a> &gt; <a href="index.html">misalignment</a> &gt; calcmisalign.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for atmat/pubtools/misalignment&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>calcmisalign
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>CALCMISALIGN will load the misalign data from the base application user</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function varargout = calcmisalign(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> CALCMISALIGN will load the misalign data from the base application user
 data area and calculate the actual misalignment to apply to THERING. This
 is then stored again in the misalignment data structure.

 CALCMISALIGN(N,DISTTYPE[,LATTICE]) where N is the number of error seeds to
 generate and DISTTYPE is the type of distribution:

 'normal' -&gt; Normally distributed
 'equal'  -&gt; Flat distribution +-sigma provided and cutoff not used.
 'sho'    -&gt; Simple harmonic oscillator distribution +-sigma (sharp edge)
             and cutoff not used.
 'abs'    -&gt; No random number generated, use sigma as the misalignment.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="testmisalignfunctions.html" class="code" title="">testmisalignfunctions</a>	% Test Misalignment Functions</li><li><a href="testrun.html" class="code" title="">testrun</a>	</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function randnum = generaterandom(sigma,num,cutoff,disttype)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function varargout = calcmisalign(varargin)</a>
0002 <span class="comment">% CALCMISALIGN will load the misalign data from the base application user</span>
0003 <span class="comment">% data area and calculate the actual misalignment to apply to THERING. This</span>
0004 <span class="comment">% is then stored again in the misalignment data structure.</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% CALCMISALIGN(N,DISTTYPE[,LATTICE]) where N is the number of error seeds to</span>
0007 <span class="comment">% generate and DISTTYPE is the type of distribution:</span>
0008 <span class="comment">%</span>
0009 <span class="comment">% 'normal' -&gt; Normally distributed</span>
0010 <span class="comment">% 'equal'  -&gt; Flat distribution +-sigma provided and cutoff not used.</span>
0011 <span class="comment">% 'sho'    -&gt; Simple harmonic oscillator distribution +-sigma (sharp edge)</span>
0012 <span class="comment">%             and cutoff not used.</span>
0013 <span class="comment">% 'abs'    -&gt; No random number generated, use sigma as the misalignment.</span>
0014 
0015 <span class="keyword">global</span> THERING
0016 
0017 <span class="keyword">if</span> ~exist(<span class="string">'THERING'</span>,<span class="string">'var'</span>)
0018     disp(<span class="string">'Please load the model first'</span>);
0019     <span class="keyword">return</span>
0020 <span class="keyword">end</span>
0021 
0022 mis = getappdata(0,<span class="string">'MisalignData'</span>);
0023 
0024 <span class="keyword">if</span> isempty(mis)
0025     disp(<span class="string">'No misalignment data found. See SETMISALIGN for more info'</span>);
0026     <span class="keyword">return</span>
0027 <span class="keyword">end</span>
0028 
0029 <span class="comment">% Parse input data</span>
0030 n = 3;
0031 <span class="keyword">if</span> nargin &gt;= n &amp; iscell(varargin{n})
0032     LATTICE = varargin{n};
0033 <span class="keyword">else</span>
0034     disp(<span class="string">'Using THERING'</span>);
0035     LATTICE = THERING;
0036 <span class="keyword">end</span>
0037 
0038 n = n - 1;
0039 <span class="keyword">if</span> nargin &gt;= n &amp; ischar(varargin{n})
0040     disttype = varargin{n};
0041 <span class="keyword">else</span>
0042     disp(<span class="string">'Default distribution: normal'</span>);
0043     disttype = <span class="string">'normal'</span>;
0044 <span class="keyword">end</span>
0045 
0046 n = n-1;
0047 <span class="keyword">if</span> nargin &gt;= n &amp; isnumeric(varargin{n})
0048     numseeds = varargin{n};
0049 <span class="keyword">else</span>
0050     disp(<span class="string">'Defaulting number of seeds to 1.'</span>);
0051     numseeds = 1;
0052 <span class="keyword">end</span>
0053 mis.numseeds = numseeds;
0054 <span class="comment">% Current seed being used on the ring</span>
0055 mis.currseed = 0;
0056 
0057 <span class="comment">% Set the 'used' parameter to 0 to initialise. Flag used to determine if</span>
0058 <span class="comment">% misalignments have been calculated for that element.</span>
0059 <span class="keyword">for</span> i=1:length(LATTICE)
0060     mis.data(i).name = LATTICE{i}.FamName;
0061     mis.data(i).used = 0;
0062     mis.data(i).val = [];
0063 <span class="keyword">end</span>
0064 
0065 <span class="comment">% Calculate the random misalignment values. At the moment the longitudinal</span>
0066 <span class="comment">% shift component, ds, will be ignored as well as thetax, and thetay for</span>
0067 <span class="comment">% the girders. These take more time to compute and at the moment or writing</span>
0068 <span class="comment">% is not seen as being necessary.</span>
0069 
0070 <span class="comment">% Calculate the individual misalignments.</span>
0071 <span class="keyword">for</span> i=1:mis.nind
0072     indices = mis.ind(i).ATindex;
0073     <span class="keyword">for</span> j=indices
0074         <span class="keyword">if</span> isempty(mis.data(j).val)
0075             mis.data(j).val = zeros(6,numseeds);
0076         <span class="keyword">end</span>
0077         mis.data(j).val = mis.data(j).val + <a href="#_sub1" class="code" title="subfunction randnum = generaterandom(sigma,num,cutoff,disttype)">generaterandom</a>(mis.ind(i).sigma,<span class="keyword">...</span>
0078             numseeds,mis.ind(i).cutoff,disttype);
0079         
0080         <span class="comment">% Flaged for easier search of elements that have been misaligned</span>
0081         mis.data(j).used = 1;
0082     <span class="keyword">end</span>
0083 <span class="keyword">end</span>
0084 
0085 <span class="comment">% Calculate the girder misalignments.</span>
0086 <span class="keyword">for</span> i=1:mis.ngird
0087     <span class="comment">% For each of the repeated girders</span>
0088     <span class="keyword">for</span> j=1:length(mis.gird(i).ATindex_girder)
0089         temp = <a href="#_sub1" class="code" title="subfunction randnum = generaterandom(sigma,num,cutoff,disttype)">generaterandom</a>(mis.gird(i).sigma,numseeds,mis.gird(i).cutoff,disttype);
0090         
0091         <span class="comment">% Use a general rotation matrix for x and y rotations of the</span>
0092         <span class="comment">% girders. A different one for each seed of course.</span>
0093         <span class="keyword">for</span> k=1:numseeds
0094             xtheta = temp(2,k);
0095             ytheta = temp(4,k);
0096             M(:,:,k) = [1      0            0        ;<span class="keyword">...</span>
0097                         0  cos(xtheta) -sin(xtheta)  ;<span class="keyword">...</span>
0098                         0  sin(xtheta)  cos(xtheta)]* <span class="keyword">...</span>
0099                        [cos(ytheta)  0  sin(ytheta)  ;<span class="keyword">...</span>
0100                              0       1      0        ;<span class="keyword">...</span>
0101                         -sin(ytheta) 0  cos(ytheta)];
0102         <span class="keyword">end</span>
0103          
0104         <span class="comment">% Find the position of the centre of mass of the girder</span>
0105         centregird = (findspos(LATTICE,mis.gird(i).ATindex_girder{j}(end)) + <span class="keyword">...</span>
0106             findspos(LATTICE,mis.gird(i).ATindex_girder{j}(1)))/2;
0107 
0108         <span class="keyword">for</span> k=mis.gird(i).ATindex_girder{j}
0109             <span class="keyword">if</span> isfield(LATTICE{k},<span class="string">'T1'</span>)
0110                 <span class="keyword">if</span> isempty(mis.data(k).val)
0111                     mis.data(k).val = zeros(6,numseeds);
0112                 <span class="keyword">end</span>
0113 
0114                 <span class="comment">% Add the shift components and only the s-axis roll.</span>
0115                 mis.data(k).val(:,:) = mis.data(k).val(:,:) + <span class="keyword">...</span>
0116                     temp(:,:);
0117                 
0118                 <span class="comment">% Calculating the contribution to x,y and s shifts due to</span>
0119                 <span class="comment">% the girder rotation about x and y axes.</span>
0120                 <span class="comment">% Describe the position of the element as a vector from the</span>
0121                 <span class="comment">% COM of the girder to the element.</span>
0122                 len = findspos(LATTICE,k) + LATTICE{k}.Length/2 - centregird;
0123                 <span class="comment">% Rotate this element position vector for each seed and</span>
0124                 <span class="comment">% determine the vector that describes the movement from the</span>
0125                 <span class="comment">% old position to the new rotated position.</span>
0126                 <span class="keyword">for</span> l=1:numseeds
0127                     oldpos_vec = [0;0;len];
0128                     newpos_vec = M(:,:,l)*oldpos_vec;
0129                     change_vec = newpos_vec-oldpos_vec;
0130                     
0131                     <span class="comment">% Apply the changes.</span>
0132                     mis.data(k).val([1 3 5],l) = mis.data(k).val([1 3 5],l) + change_vec;
0133                 <span class="keyword">end</span>
0134                 
0135                 <span class="comment">% Flaged for easier search of elements that have been</span>
0136                 <span class="comment">% misaligned</span>
0137                 mis.data(k).used = 1;
0138             <span class="keyword">end</span>
0139         <span class="keyword">end</span>
0140     <span class="keyword">end</span>
0141 <span class="keyword">end</span>
0142 
0143 disp(<span class="string">'Finished calculation the misalignments'</span>);
0144 setappdata(0,<span class="string">'MisalignData'</span>,mis);
0145 
0146 
0147 
0148 <a name="_sub1" href="#_subfunctions" class="code">function randnum = generaterandom(sigma,num,cutoff,disttype)</a>
0149 <span class="comment">% Expects sigma to be a 6 x 1 vector but will still handle it if its a 1 x</span>
0150 <span class="comment">% 6 vector.</span>
0151 
0152 sigmatrix = repmat(reshape(sigma,6,1),1,num);
0153 
0154 <span class="keyword">switch</span> disttype
0155     <span class="keyword">case</span> <span class="string">'normal'</span>
0156         <span class="comment">% Normal distribution</span>
0157         <span class="comment">% randnum is a 6 x num matrix</span>
0158         randnum = sigmatrix.*randn(6, num);
0159         <span class="comment">% If cutoff == 0 then don't cut anything.</span>
0160         <span class="keyword">if</span> cutoff ~= 0
0161             ind = find(abs(randnum) &gt; cutoff*sigmatrix);
0162             <span class="keyword">while</span> ~isempty(ind)
0163                 randnum(ind) = sigmatrix(ind).*randn(length(ind),1);
0164                 ind = find(abs(randnum) &gt; cutoff.*sigmatrix);
0165             <span class="keyword">end</span>
0166         <span class="keyword">end</span>
0167     <span class="keyword">case</span> <span class="string">'equal'</span>
0168         <span class="comment">% Equal/Flat distribution</span>
0169         <span class="comment">% Cutoff ignored completely</span>
0170         randnum = sigmatrix.*(2*rand(6, num) - 1);
0171     <span class="keyword">case</span> <span class="string">'sho'</span>
0172         <span class="comment">% Simple harmonic oscillator distribution</span>
0173         randnum = sigmatrix.*sin(rand(6, num)*2*pi);
0174     <span class="keyword">case</span> <span class="string">'abs'</span>
0175         <span class="comment">% Use the values provided. No randomness.</span>
0176         randnum = sigmatrix;
0177     <span class="keyword">otherwise</span>
0178         disp([<span class="string">'Unknown distribution: '</span> disttype]);
0179         randnum = [];
0180 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Sun 28-Jul-2013 23:18:56 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>