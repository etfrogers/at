<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of applymisalign</title>
  <meta name="keywords" content="applymisalign">
  <meta name="description" content="APPLYMISALIGN will read the misalignment data structure and apply it to">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">atmat</a> &gt; <a href="../index.html">pubtools</a> &gt; <a href="index.html">misalignment</a> &gt; applymisalign.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for atmat/pubtools/misalignment&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>applymisalign
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>APPLYMISALIGN will read the misalignment data structure and apply it to</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function varargout = applymisalign(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> APPLYMISALIGN will read the misalignment data structure and apply it to
 THERING elements. 

 LATTICE = APPLYMISALIGN([SEED, LATTICE]). If more than one seed has been 
 generated using CALCMISALIGN then repeated calling of APPLYMISALIGN will 
 apply the subsequent seeds untill all have been used and the user will 
 have to generate more seeds. The seed that is currently being used is 
 saved in the misalignment datastructure under the field 'currseed'. If 
 SEED is defined then that particular seed will be applied and the running
 'currseed' will not be incremented.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="closedorbit.html" class="code" title="">closedorbit</a>	</li><li><a href="testmisalignfunctions.html" class="code" title="">testmisalignfunctions</a>	% Test Misalignment Functions</li><li><a href="testrun.html" class="code" title="">testrun</a>	</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function varargout = applymisalign(varargin)</a>
0002 <span class="comment">% APPLYMISALIGN will read the misalignment data structure and apply it to</span>
0003 <span class="comment">% THERING elements.</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% LATTICE = APPLYMISALIGN([SEED, LATTICE]). If more than one seed has been</span>
0006 <span class="comment">% generated using CALCMISALIGN then repeated calling of APPLYMISALIGN will</span>
0007 <span class="comment">% apply the subsequent seeds untill all have been used and the user will</span>
0008 <span class="comment">% have to generate more seeds. The seed that is currently being used is</span>
0009 <span class="comment">% saved in the misalignment datastructure under the field 'currseed'. If</span>
0010 <span class="comment">% SEED is defined then that particular seed will be applied and the running</span>
0011 <span class="comment">% 'currseed' will not be incremented.</span>
0012 <span class="comment">%</span>
0013 
0014 <span class="keyword">global</span> THERING
0015 
0016 <span class="keyword">if</span> ~exist(<span class="string">'THERING'</span>,<span class="string">'var'</span>)
0017     disp(<span class="string">'Please load the model first'</span>);
0018     <span class="keyword">return</span>
0019 <span class="keyword">end</span>
0020 
0021 [reg prop] = parseparams(varargin);
0022 verbatim = 1;
0023 <span class="keyword">for</span> i=1:length(prop)
0024     <span class="keyword">if</span> strcmpi(prop,<span class="string">'quiet'</span>)
0025         verbatim = 0;
0026     <span class="keyword">end</span>
0027 <span class="keyword">end</span>
0028 
0029 mis = getappdata(0,<span class="string">'MisalignData'</span>);
0030 
0031 <span class="keyword">if</span> isempty(mis)
0032     disp(<span class="string">'No misalignment data found. See SETMISALIGN for more info'</span>);
0033     <span class="keyword">return</span>
0034 <span class="keyword">end</span>
0035 
0036 n = 2;
0037 <span class="keyword">if</span> nargin &gt;= n &amp; iscell(varargin{n})
0038     LATTICE = varargin{n};
0039 <span class="keyword">else</span>
0040     disp(<span class="string">'Using THERING'</span>);
0041     LATTICE = THERING;
0042 <span class="keyword">end</span>
0043 
0044 n = n-1;
0045 <span class="keyword">if</span> nargin &gt;= n &amp; isnumeric(varargin{n})
0046     mis.currseed = varargin{n};
0047 <span class="keyword">else</span>
0048     mis.currseed = mis.currseed + 1;
0049     <span class="keyword">if</span> mis.currseed &gt; mis.numseeds
0050         disp(<span class="string">'All seeds used. Doing nothing'</span>)
0051         <span class="keyword">return</span>
0052     <span class="keyword">end</span>
0053 <span class="keyword">end</span>
0054     
0055 <span class="comment">% Indices of elements where misalignemnt data may need to be applied.</span>
0056 indices = find(cell2mat({mis.data.used}));
0057 <span class="comment">% Cancatenate all the misalignment data into one huge matrix.</span>
0058 temp = cell2mat({mis.data(indices).val});
0059 <span class="comment">% Filtering out the seeds being used.</span>
0060 misalignval = zeros(6,length(indices));
0061 misalignval = temp(1:6,[mis.currseed:mis.numseeds:end]);
0062 
0063 <span class="comment">% Separate out the individual shifts</span>
0064 xshift = misalignval(1,:);
0065 xrot   = misalignval(2,:);
0066 yshift = misalignval(3,:);
0067 yrot   = misalignval(4,:);
0068 sshift = misalignval(5,:);
0069 srot   = misalignval(6,:);
0070 
0071 <span class="comment">% Hack so that I don't have to change the functions below to accept</span>
0072 <span class="comment">% arbritrary lattices</span>
0073 TEMP = THERING;
0074 THERING = LATTICE;
0075 
0076 <span class="comment">% Set and add the rotations because these affect T1 and T2.</span>
0077 setshift(indices,xshift,yshift);
0078 addxrot(indices,xrot);
0079 addyrot(indices,yrot);
0080 <span class="comment">% This is ok to set since the roll affects R1 and R2 only.</span>
0081 addsrot(indices,srot);
0082 <span class="comment">% INCOMPLETE</span>
0083 <span class="comment">% addsshift(indices,sshift);</span>
0084 
0085 <span class="comment">% Put everything back</span>
0086 LATTICE = THERING;
0087 THERING = TEMP;
0088 clear TEMP;
0089 
0090 <span class="keyword">if</span> verbatim
0091     disp([<span class="string">'Applied random misalignemnt. Using seed number '</span> num2str(mis.currseed)]);
0092 <span class="keyword">end</span>
0093 
0094 <span class="comment">% Saving some info for plotting and analysis of applied misalignments</span>
0095 <span class="comment">% get the SPos data</span>
0096 TD3 = twissring(LATTICE,0,1:length(LATTICE));
0097 S3 = cat(2,TD3.SPos);
0098 mis.applied(mis.currseed).spos = S3;
0099 mis.applied(mis.currseed).deltax = zeros(1,length(LATTICE)); 
0100 mis.applied(mis.currseed).deltax(indices) = xshift;
0101 mis.applied(mis.currseed).deltay = zeros(1,length(LATTICE)); 
0102 mis.applied(mis.currseed).deltay(indices) = yshift;
0103 mis.applied(mis.currseed).deltas = zeros(1,length(LATTICE)); 
0104 mis.applied(mis.currseed).deltas(indices) = sshift;
0105 
0106 
0107 setappdata(0,<span class="string">'MisalignData'</span>,mis);
0108 
0109 <span class="keyword">if</span> nargout == 1
0110     varargout{1} = LATTICE;
0111 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Sun 28-Jul-2013 23:18:56 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>